<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laboratorio de Pentatónicas y Arpegios</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        /* General Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #d1d5db;
        }
        .container {
            max-width: 1500px;
            margin: 0 auto;
            padding: 1rem;
        }
        .tabs button {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 500;
            color: #9ca3af;
            background-color: #1f2937;
            border: 1px solid transparent;
            transition: all 0.3s ease;
        }
        .tabs button.active {
            background-color: #3b82f6;
            color: #fff;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        .tabs button:hover:not(.active) {
            background-color: #374151;
            color: #e5e7eb;
        }
        .tab-content {
            background-color: #1f2937;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            margin-top: 1.5rem;
        }
        h1, h2, h3 { color: #fff; }
        .input-group {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }
        .input-group label {
            font-weight: 500;
            color: #fff;
        }
        .input-group select, .input-group input[type="number"], .input-group input[type="range"], .input-group input[type="checkbox"] {
            background-color: #374151;
            border-radius: 8px;
            padding: 0.5rem;
            border: 1px solid #4b5563;
            color: #fff;
        }
         .input-group input[type="checkbox"] {
            height: 1.25rem;
            width: 1.25rem;
            padding: 0;
         }
        .action-button {
            background-color: #3b82f6;
            color: #fff;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: bold;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        .action-button:hover {
            background-color: #2563eb;
            box-shadow: 0 2px 10px rgba(59, 130, 246, 0.4);
        }
        .action-button.stop-btn { background-color: #ef4444; }
        .action-button.stop-btn:hover { background-color: #dc2626; }

        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        th, td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid #374151;
            vertical-align: top;
            font-size: 0.9rem;
        }
        th {
            background-color: #374151;
            font-weight: 600;
        }
        tr.selected-row {
            background-color: #3b82f6;
        }
        tr.selected-row, tr.selected-row .text-gray-400 {
            color: #ffffff;
        }
        tr:last-child td { border-bottom: none; }
        .example-box {
            background-color: #374151;
            padding: 0.5rem;
            border-radius: 8px;
            margin-top: 0.5rem;
            font-family: monospace;
            font-size: 0.75rem;
            color: #fff;
            white-space: pre;
            overflow-x: auto;
        }

        /* Fretboard Visualizer Styles */
        .visualizer-container {
            background-color: #111827;
            padding: 1rem 0;
            border-radius: 8px;
            margin-top: 1.5rem;
            width: 100%;
            overflow-x: auto;
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
            text-align: center; /* Center the inline-block fretboard area */
        }
        .visualizer-container::-webkit-scrollbar {
             display: none; /* Chrome, Safari, Opera */
        }
        .fretboard-area {
            display: inline-flex; /* Changed to inline-flex */
            flex-direction: column;
            align-items: flex-start;
            padding: 0 1rem;
        }
        .fretboard-content {
            display: flex;
            align-items: center;
        }
        .open-strings {
            display: flex;
            flex-direction: column;
            margin-right: 8px;
            font-weight: bold;
            font-size: 0.9rem;
        }
        .open-string-name {
            height: 26px; 
            display: flex;
            align-items: center;
            color: #6b7280;
            transition: color 0.3s ease;
        }
        .open-string-name.in-scale { color: #e5e7eb; }
        .open-string-name.root { color: #ef4444; }

        .fretboard-wrapper {
            position: relative;
            padding: 5px 0;
            display: inline-block;
        }
        .fretboard {
            background-color: #6b3e24;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            border: 1px solid #4a2c1a;
        }
        .string {
            display: flex;
            align-items: center;
            height: 25px;
        }
        .string:not(:last-child) { border-bottom: 1px solid #4a2c1a; }
        .fret {
            width: 50px; /* Increased width */
            height: 100%;
            border-right: 1px solid #a0a0a0;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .fret.nut {
            border-right: 4px solid #2d1a0e;
            width: 10px;
        }
        .note-fixed {
            color: #4a2c1a;
            font-size: 0.7rem;
            font-weight: bold;
            transition: all 0.2s ease-in-out;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        .note-fixed.in-scale {
            background-color: #3b82f6;
            color: white;
            transform: scale(1.1);
        }
        .note-fixed.root { background-color: #ef4444; }
        .note-fixed.playing {
            box-shadow: 0 0 15px 5px #fef08a; /* Yellow glow */
            transform: scale(1.2);
        }
        .open-string-name.playing {
            text-shadow: 0 0 10px #fef08a;
        }
        .inlay-container {
            position: absolute;
            top: 0;
            left: 10px;
            width: calc(100% - 10px);
            height: 100%;
            display: flex;
            pointer-events: none;
        }
        .inlay-fret {
            width: 50px; /* Increased width */
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        .inlay-dot {
            width: 6px;
            height: 6px;
            background-color: #d1c1a9;
            border-radius: 50%;
            position: absolute;
        }
        .inlay-dot.double {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            height: 100%; 
            background-color: transparent;
        }
        .inlay-dot.double::before, .inlay-dot.double::after {
            content: '';
            width: 6px;
            height: 6px;
            background-color: #d1c1a9;
            border-radius: 50%;
        }
        .fret-numbers {
            display: flex;
            margin-left: 18px; /* open-strings width + nut width */
            padding-top: 4px;
        }
        .fret-number {
            width: 50px; /* Increased width */
            flex-shrink: 0;
            text-align: center;
            font-size: 0.75rem;
            color: #9ca3af;
        }
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #4b5563;
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        input[type="range"]:hover {
            opacity: 1;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
        }

        /* Note Span Highlighting */
        .note-span {
            transition: all 0.1s ease-in-out;
            display: inline-block;
        }
        .note-span.playing {
            color: #fef08a;
            text-shadow: 0 0 8px #fef08a;
            transform: scale(1.1);
        }

    </style>
</head>
<body class="bg-gray-900 text-gray-200">
    <div class="container">
        <h1 class="text-4xl font-bold text-center my-8">Laboratorio de Pentatónicas</h1>
        <p class="text-center text-lg mb-4 text-gray-400">
            Conceptos de improvisación con pentatónicas.
        </p>
        <p class="text-center text-sm mb-8 text-gray-500">
            Por: Juan Miguel Rios Redondo
        </p>
        
        <!-- Tab 1: Pentatonics & Arpeggios -->
        <div class="tab-content" id="tab-simple">
            <h2 class="text-2xl font-semibold mb-4 text-center">Explorador de Pentatónicas y Arpegios Derivados</h2>
            <div class="input-group">
                <label for="root-note">Tonalidad del Acorde:</label>
                <select id="root-note"></select>
                <label for="chord-type">Tipo de Acorde:</label>
                <select id="chord-type"></select>
                <button id="enharmonic-btn" class="action-button">Enarmónico</button>
            </div>
            <div id="simple-mode-content">
                <table class="bg-gray-800 rounded-lg overflow-hidden">
                    <thead>
                        <tr>
                            <th class="rounded-tl-lg">Pentatónica a usar</th>
                            <th>Tríadas Derivadas</th>
                            <th>Tétradas Derivadas</th>
                            <th>Grados sobre el Acorde</th>
                            <th class="rounded-tr-lg">Lógica y Sonido</th>
                        </tr>
                    </thead>
                    <tbody id="scale-table-body">
                    </tbody>
                </table>
                
                <div class="mt-8 p-4 bg-gray-800 rounded-lg">
                    <h3 class="text-xl font-semibold mb-4 text-center">Laboratorio de Melodías y Arpegios</h3>
                     <div class="input-group">
                        <label for="bpm-slider" class="font-semibold">Metrónomo:</label>
                        <input type="range" id="bpm-slider" min="40" max="300" value="120" class="flex-grow">
                        <span id="bpm-value" class="font-bold w-12 text-center bg-gray-700 rounded-md py-1">120 BPM</span>
                    </div>
                    <div class="input-group">
                        <select id="arpeggio-type-select">
                            <option value="triads">Tríadas</option>
                            <option value="tetrads">Tétradas</option>
                        </select>
                        <select id="arpeggio-select" class="flex-grow"></select>
                        <button id="add-arpeggio-btn" class="action-button">Agregar/Actualizar Arpegio</button>
                        <div class="flex items-center">
                            <input type="checkbox" id="arpeggio-random-order">
                            <label for="arpeggio-random-order" class="ml-2">Orden Aleatorio</label>
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="rhythm-select" class="font-semibold">Ritmo:</label>
                        <select id="rhythm-select">
                            <option value="4n">Negra</option>
                            <option value="8n" selected>Corchea</option>
                            <option value="16n">Semicorchea</option>
                        </select>
                        <label for="random-note-count" class="ml-4">Notas Aleatorias (1-5):</label>
                        <input type="number" id="random-note-count" min="1" max="5" value="3" class="w-20 text-center">
                        <button id="add-random-btn" class="action-button bg-yellow-600 hover:bg-yellow-500">Generar Aleatorio</button>
                    </div>
                    <div id="generator-output" class="text-center font-mono text-lg p-4 bg-gray-900 rounded-lg min-h-[3rem] flex items-center justify-center mb-4">
                        <!-- Melody will appear here -->
                    </div>
                    <div class="input-group">
                        <button id="play-melody-btn" class="action-button">Play Melodía</button>
                        <button id="play-arpeggios-btn" class="action-button bg-green-600 hover:bg-green-500">Play Arpegios</button>
                        <button id="stop-melody-btn" class="action-button stop-btn">Stop</button>
                        <button id="clear-melody-btn" class="action-button bg-gray-600 hover:bg-gray-500">Limpiar</button>
                    </div>
                </div>

                <div class="visualizer-container" id="fretboard-container-simple">
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATA AND CONFIGURATIONS ---
        const FLAT_NOTES = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
        const SHARP_NOTES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        
        const ENHARMONIC_MAP = {
            'C#': 'Db', 'Db': 'C#', 'D#': 'Eb', 'Eb': 'D#', 'F#': 'Gb', 'Gb': 'F#',
            'G#': 'Ab', 'Ab': 'G#', 'A#': 'Bb', 'Bb': 'A#', 'B#': 'C', 'Cb': 'B',
            'E#': 'F', 'Fb': 'E', 'Bbb': 'A'
        };

        const KEY_SIGNATURES = {
            'C':  { type: 'sharp', scale: ['C', 'D', 'E', 'F', 'G', 'A', 'B'] }, 'G':  { type: 'sharp', scale: ['G', 'A', 'B', 'C', 'D', 'E', 'F#'] },
            'D':  { type: 'sharp', scale: ['D', 'E', 'F#', 'G', 'A', 'B', 'C#'] }, 'A':  { type: 'sharp', scale: ['A', 'B', 'C#', 'D', 'E', 'F#', 'G#'] },
            'E':  { type: 'sharp', scale: ['E', 'F#', 'G#', 'A', 'B', 'C#', 'D#'] }, 'B':  { type: 'sharp', scale: ['B', 'C#', 'D#', 'E', 'F#', 'G#', 'A#'] },
            'F#': { type: 'sharp', scale: ['F#', 'G#', 'A#', 'B', 'C#', 'D#', 'E#'] }, 'C#': { type: 'sharp', scale: ['C#', 'D#', 'E#', 'F#', 'G#', 'A#', 'B#'] },
            'F':  { type: 'flat',  scale: ['F', 'G', 'A', 'Bb', 'C', 'D', 'E'] }, 'Bb': { type: 'flat',  scale: ['Bb', 'C', 'D', 'Eb', 'F', 'G', 'A'] },
            'Eb': { type: 'flat',  scale: ['Eb', 'F', 'G', 'Ab', 'Bb', 'C', 'D'] }, 'Ab': { type: 'flat',  scale: ['Ab', 'Bb', 'C', 'Db', 'Eb', 'F', 'G'] },
            'Db': { type: 'flat',  scale: ['Db', 'Eb', 'F', 'Gb', 'Ab', 'Bb', 'C'] }, 'Gb': { type: 'flat',  scale: ['Gb', 'Ab', 'Bb', 'Cb', 'Db', 'Eb', 'F'] },
            'Cb': { type: 'flat',  scale: ['Cb', 'Db', 'Eb', 'Fb', 'Gb', 'Ab', 'Bb'] }
        };
        
        const noteNameToIndex = (name) => {
            const flatIndex = FLAT_NOTES.indexOf(name);
            return (flatIndex !== -1) ? flatIndex : SHARP_NOTES.indexOf(name);
        };
        
        const getPreferredNotes = (note, chordType) => {
            const keySig = KEY_SIGNATURES[note];
            if (keySig) return keySig.type === 'flat' ? FLAT_NOTES : SHARP_NOTES;
            if (chordType.includes('m') || chordType.includes('alt') || note.includes('b')) return FLAT_NOTES;
            return SHARP_NOTES;
        };

        const getNoteFromInterval = (rootNote, interval, preferredNotes) => {
            const rootIndex = noteNameToIndex(rootNote);
            const finalIndex = (rootIndex + interval) % 12;
            return preferredNotes[finalIndex];
        };
        
        const getIntervalName = (rootNote, targetNote, chordType) => {
            const rootIndex = noteNameToIndex(rootNote);
            const targetIndex = noteNameToIndex(targetNote);
            const interval = (targetIndex - rootIndex + 12) % 12;
            
            switch (interval) {
                case 0: return 'R'; case 1: return 'b9'; case 2: return '9';
                case 3: return chordType.includes('m') ? 'b3' : '#9';
                case 4: return '3'; case 5: return '11';
                case 6: return chordType.includes('dom') || chordType.includes('alt') ? '#11' : 'b5';
                case 7: return '5'; case 8: return chordType.includes('m') ? 'b6' : '#5';
                case 9: return chordType.includes('m') ? '6' : 'b13';
                case 10: return 'b7'; case 11: return '7'; default: return '?';
            }
        };

        const assignOctaves = (notes) => {
            if (!notes || notes.length === 0) return [];
            let currentOctave = 4;
            let lastNoteIndex = -1;
            const notesWithOctaves = [];

            notes.forEach(note => {
                if(note === null) {
                    notesWithOctaves.push(null);
                    return;
                }

                const currentNoteIndex = noteNameToIndex(note);
                if (lastNoteIndex !== -1 && currentNoteIndex < lastNoteIndex) {
                    if (currentOctave < 5) {
                        currentOctave++;
                    }
                }
                notesWithOctaves.push(note + currentOctave);
                lastNoteIndex = currentNoteIndex;
            });

            return notesWithOctaves;
        };
        
        const pentatonicFormulas = {
            'minor': [0, 3, 5, 7, 10], 'dom7': [0, 2, 4, 7, 10],
            'm7b5': [0, 3, 5, 6, 10], 'majb6': [0, 2, 4, 7, 8]
        };

        const PENTATONIC_DISPLAY_NAMES = {
            'minor': 'minor',
            'dom7': 'dom7',
            'm7b5': 'm7(b5)',
            'majb6': 'maj(b6)'
        };
        
        const chordTypes = {
            'maj7': 'Mayor (Maj7)', 'm7': 'Menor (m7)', 'dom7': 'Dominante (V7)',
            'm7b5': 'Menor 7b5 (ø)', 'alt': 'Dominante Alterado (V7alt)'
        };
        const pentatonicToChordRelations = {
            'maj7': [
                { name: 'Menor del 3er grado', pentatonicRoot: (r) => (r + 4) % 12, type: 'minor', logic: 'La mejor opción, excelentes tensiones.' },
                { name: 'Menor del 7mo grado', pentatonicRoot: (r) => (r + 11) % 12, type: 'minor', logic: 'Introduce el sonido Lidio (#11).' },
                { name: 'Menor del 6to grado', pentatonicRoot: (r) => (r + 9) % 12, type: 'minor', logic: 'Aporta un sonido bluesy.'},
                { name: 'Major b6 del 3er grado', pentatonicRoot: (r) => (r + 4) % 12, type: 'majb6', logic: 'Crea un sonido Maj7#5.'},
                { name: 'm7b5 del #4', pentatonicRoot: (r) => (r + 6) % 12, type: 'm7b5', logic: 'Sonido Lidio con #11 y 13.'}
            ],
            'm7': [
                { name: 'Menor de la raíz', pentatonicRoot: (r) => r, type: 'minor', logic: 'La opción más directa y segura.' },
                { name: 'Menor del 5to grado', pentatonicRoot: (r) => (r + 7) % 12, type: 'minor', logic: 'Sonido Dórico, añade la 9na.' },
                { name: 'Menor del 2do grado', pentatonicRoot: (r) => (r + 2) % 12, type: 'minor', logic: 'Añade la 9na y la 13ra.'}
            ],
            'dom7': [
                { name: 'Menor del 5to grado', pentatonicRoot: (r) => (r + 7) % 12, type: 'minor', logic: 'Opción Mixolidia estándar.' },
                { name: 'Dominante de la raíz', pentatonicRoot: (r) => r, type: 'dom7', logic: 'La pentatónica de dominante básica.' },
                { name: 'Menor del 6to grado', pentatonicRoot: (r) => (r + 9) % 12, type: 'minor', logic: 'Sonido muy bluesy.'},
                { name: 'm7b5 del 3er grado', pentatonicRoot: (r) => (r + 4) % 12, type: 'm7b5', logic: 'Introduce la b13 para un sonido alterado suave.'},
                { name: 'Majb6 del 2do grado', pentatonicRoot: (r) => (r + 2) % 12, type: 'majb6', logic: 'Sonido Lidio Dominante (#11).'}
            ],
            'm7b5': [
                { name: 'Menor del b3', pentatonicRoot: (r) => (r + 3) % 12, type: 'minor', logic: 'Una de las opciones preferidas en jazz.' },
                { name: 'm7b5 de la raíz', pentatonicRoot: (r) => r, type: 'm7b5', logic: 'La escala más directa para el acorde.'},
                { name: 'Dominante del b6', pentatonicRoot: (r) => (r + 8) % 12, type: 'dom7', logic: 'Genera 9 y 13 sobre el acorde.'},
            ],
            'alt': [
                { name: 'Menor del #9', pentatonicRoot: (r) => (r + 3) % 12, type: 'minor', logic: 'Cubre todas las alteraciones importantes.' },
                { name: 'Dominante del b5', pentatonicRoot: (r) => (r + 6) % 12, type: 'dom7', logic: 'Opción de tritono, muy potente.' },
                { name: 'Major b6 del b6', pentatonicRoot: (r) => (r + 8) % 12, type: 'majb6', logic: 'Sonido avanzado con #9 y b13.'},
                { name: 'm7b5 del b7', pentatonicRoot: (r) => (r + 10) % 12, type: 'm7b5', logic: 'Cubre b9, #9, y #5.'}
            ]
        };
        const guitarTuning = [4, 9, 2, 7, 11, 4]; // E A D G B e

        const ARPEGGIO_DEFINITIONS = {
            'minor': {
                notesMap: {'1': 0, 'b3': 1, '4': 2, '5': 3, 'b7': 4},
                triadas: [
                    { quality: 'm', rootKey: '1', notes: ['1', 'b3', '5'] },
                    { quality: 'sus2', rootKey: 'b3', notes: ['b3', '4', 'b7'] },
                    { quality: 'sus2', rootKey: '4', notes: ['4', '5', '1'] },
                    { quality: '', rootKey: 'b3', bassKey: '5', notes: ['5', 'b7', 'b3'] },
                    { quality: 'sus2', rootKey: 'b7', notes: ['b7', '1', '4'] }
                ],
                tetradas: [
                    { quality: 'm7', rootKey: '1', notes: ['1', 'b3', '5', 'b7'] },
                    { quality: '6sus2', rootKey: 'b3', notes: ['b3', '4', 'b7', '1'] },
                    { quality: '7sus2', rootKey: '4', notes: ['4', '5', '1', 'b3'] },
                    { quality: 'add9', rootKey: 'b3', bassKey: '5', notes: ['5', 'b7', 'b3', '4'] },
                    { quality: '6sus2', rootKey: 'b7', notes: ['b7', '1', '4', '5'] }
                ]
            },
            'dom7': {
                notesMap: {'1': 0, '2': 1, '3': 2, '5': 3, 'b7': 4},
                triadas: [
                    { quality: '', rootKey: '1', notes: ['1', '3', '5'] },
                    { quality: 'm', rootKey: '5', bassKey: '2', notes: ['2', '5', 'b7'] },
                    { quality: '7(omit5)', rootKey: '1', bassKey: '3', notes: ['3', 'b7', '1'] },
                    { quality: 'sus4', rootKey: '5', notes: ['5', '1', '2'] },
                    { quality: '', rootKey: '2', bassKey: 'b7', notes: ['b7', '2', '5'] }
                ],
                tetradas: [
                    { quality: '7', rootKey: '1', notes: ['1', '3', '5', 'b7'] },
                    { quality: 'm7', rootKey: '5', bassKey: '2', notes: ['2', '5', 'b7', '1'] },
                    { quality: '7(add9)', rootKey: '1', bassKey: '3', notes: ['3', 'b7', '1', '2'] },
                    { quality: 'm6', rootKey: '5', notes: ['5', 'b7', '2', '3'] },
                    { quality: 'sus2', rootKey: '1', bassKey: 'b7', notes: ['b7', '1', '2', '5'] }
                ]
            },
            'm7b5': {
                notesMap: {'1': 0, 'b3': 1, '4': 2, 'b5': 3, 'b7': 4},
                triadas: [
                    { quality: 'sus4', rootKey: '1', notes: ['1', '4', 'b7'] },
                    { quality: 'dim', rootKey: '1', bassKey: 'b3', notes: ['b3', 'b5', '1'] },
                    { quality: ' (cuartal)', rootKey: '4', notes: ['4', 'b7', 'b3'] },
                    { quality: ' (shell)', rootKey: 'b5', notes: ['b5', 'b7', '4'] },
                    { quality: 'sus4', rootKey: '1', bassKey: 'b7', notes: ['b7', '1', '4'] }
                ],
                tetradas: [
                    { quality: 'm7b5', rootKey: '1', notes: ['1', 'b3', 'b5', 'b7'] },
                    { quality: 'dim(add11)', rootKey: '1', bassKey: 'b3', notes: ['b3', 'b5', '1', '4'] },
                    { quality: 'm7sus4', rootKey: '1', notes: ['4', 'b7', '1', 'b3'] },
                    { quality: '7sus4', rootKey: 'b7', bassKey: 'b5', notes: ['b5', 'b7', '1', '4'] },
                    { quality: 'm7', rootKey: '4', bassKey: 'b7', notes: ['b7', '1', 'b3', '4'] }
                ]
            },
            'majb6': {
                notesMap: {'1': 0, '2': 1, '3': 2, '5': 3, 'b6': 4},
                triadas: [
                    { quality: 'sus2', rootKey: '1', notes: ['1', '2', '5'] },
                    { quality: '', rootKey: '1', bassKey: '2', notes: ['2', '5', '1'] },
                    { quality: 'aug', rootKey: '3', notes: ['3', 'b6', '1'] },
                    { quality: '', rootKey: '1', bassKey: '5', notes: ['5', '1', '3'] },
                    { quality: 'aug', rootKey: 'b6', notes: ['b6', '1', '3'] }
                ],
                tetradas: [
                    { quality: 'maj7#5', rootKey: 'b6', notes: ['1', '3', '5', 'b6'] },
                    { quality: 'maj7', rootKey: '1', bassKey: '2', notes: ['2', '3', '5', '1'] },
                    { quality: '7aug', rootKey: '3', notes: ['3', 'b6', '1', '2'] },
                    { quality: 'sus4(b9)', rootKey: '5', notes: ['5', 'b6', '1', '2'] },
                    { quality: 'maj7#11', rootKey: 'b6', notes: ['b6', '1', '2', '3'] }
                ]
            }
        };

        const getArpeggiosForPentatonic = (pentatonicNotes, type) => {
            const definitions = ARPEGGIO_DEFINITIONS[type];
            if (!definitions || !pentatonicNotes || pentatonicNotes.length !== 5) {
                return { triadas: [], tetradas: [] };
            }

            const formatArpeggio = (definition) => {
                try {
                    const arpeggioNotes = definition.notes.map(noteKey => pentatonicNotes[definitions.notesMap[noteKey]]);
                    const chordRootNote = pentatonicNotes[definitions.notesMap[definition.rootKey]];
                    let finalName = `${chordRootNote}${definition.quality}`;
                    if (definition.bassKey) {
                        const bassNote = pentatonicNotes[definitions.notesMap[definition.bassKey]];
                        finalName += `/${bassNote}`;
                    }
                    return `${finalName}: ${arpeggioNotes.join(', ')}`;
                } catch (e) {
                    console.error(e.message, {definition, pentatonicNotes, type});
                    return 'Error: Invalid arpeggio definition';
                }
            };
            
            const triadas = definitions.triadas.map(formatArpeggio);
            const tetradas = definitions.tetradas.map(formatArpeggio);

            return { triadas, tetradas };
        };

        // --- Tone.js and other variables ---
        let isToneStarted = false;
        const reverb = new Tone.Reverb({ decay: 1.5, preDelay: 0.01 }).toDestination();
        const melodySynth = new Tone.FMSynth({
            harmonicity: 1.5,
            modulationIndex: 8,
            envelope: { attack: 0.01, decay: 0.3, sustain: 0.1, release: 0.8 },
            modulationEnvelope: { attack: 0.01, decay: 0.15, sustain: 0.1, release: 0.2 }
        }).connect(reverb);
        const stopPlayback = () => { if(Tone.Transport.state === 'started') {Tone.Transport.stop();} Tone.Transport.cancel(); };
        
        let randomMelodyPart = [];
        let arpeggioMelodyPart = [];

        // --- DOM Elements ---
        const rootNoteSelect = document.getElementById('root-note');
        const chordTypeSelect = document.getElementById('chord-type');
        const tableBody = document.getElementById('scale-table-body');
        const simpleModeContent = document.getElementById('simple-mode-content');
        const arpeggioTypeSelect = document.getElementById('arpeggio-type-select');
        const arpeggioSelect = document.getElementById('arpeggio-select');
        const bpmSlider = document.getElementById('bpm-slider');
        const bpmValue = document.getElementById('bpm-value');
        const rhythmSelect = document.getElementById('rhythm-select');
        const generatorOutput = document.getElementById('generator-output');


        const createFretboard = (containerId, numFrets = 17) => {
            const container = document.getElementById(containerId);
            container.innerHTML = ''; 

            const area = document.createElement('div');
            area.className = 'fretboard-area';
            
            const content = document.createElement('div');
            content.className = 'fretboard-content';

            const openStringsContainer = document.createElement('div');
            openStringsContainer.className = 'open-strings';
            ['E', 'B', 'G', 'D', 'A', 'E'].forEach(noteName => {
                const nameDiv = document.createElement('div');
                nameDiv.className = 'open-string-name';
                nameDiv.textContent = noteName;
                openStringsContainer.appendChild(nameDiv);
            });
            content.appendChild(openStringsContainer);

            const wrapper = document.createElement('div');
            wrapper.className = 'fretboard-wrapper';

            const fretboard = document.createElement('div');
            fretboard.className = 'fretboard';
            
            const reversedTuning = [...guitarTuning].reverse();
            reversedTuning.forEach((openNoteIndex, stringIndex) => {
                const stringDiv = document.createElement('div');
                stringDiv.className = 'string';
                
                const nut = document.createElement('div');
                nut.className = 'fret nut';
                stringDiv.appendChild(nut);
                
                for (let i = 0; i < numFrets; i++) {
                    const fret = document.createElement('div');
                    fret.className = 'fret';
                    
                    const noteFixed = document.createElement('div');
                    noteFixed.className = 'note-fixed';
                    const noteIndex = (openNoteIndex + i + 1) % 12;
                    noteFixed.textContent = SHARP_NOTES[noteIndex];
                    fret.appendChild(noteFixed);

                    stringDiv.appendChild(fret);
                }
                fretboard.appendChild(stringDiv);
            });
            wrapper.appendChild(fretboard);
            
            const inlayContainer = document.createElement('div');
            inlayContainer.className = 'inlay-container';
            const markers = { 3: 'single', 5: 'single', 7: 'single', 9: 'single', 12: 'double', 15: 'single', 17: 'single' };
            
            for (let i = 1; i <= numFrets; i++) {
                const inlayFret = document.createElement('div');
                inlayFret.className = 'inlay-fret';
                if (markers[i]) {
                    const dot = document.createElement('div');
                    dot.className = `inlay-dot ${markers[i] === 'double' ? 'double' : ''}`;
                    inlayFret.appendChild(dot);
                }
                inlayContainer.appendChild(inlayFret);
            }
            wrapper.appendChild(inlayContainer);
            content.appendChild(wrapper);
            area.appendChild(content);

            // Add Fret Numbers
            const fretNumbersContainer = document.createElement('div');
            fretNumbersContainer.className = 'fret-numbers';
            const numbers = { 3: '3', 5: '5', 7: '7', 9: '9', 12: '12', 15: '15' };

            // Empty div for the nut space
            const nutSpacer = document.createElement('div');
            nutSpacer.style.width = '10px'; 
            nutSpacer.style.flexShrink = '0';
            fretNumbersContainer.appendChild(nutSpacer);

            for (let i = 1; i <= numFrets; i++) {
                const numDiv = document.createElement('div');
                numDiv.className = 'fret-number';
                if (numbers[i]) {
                    numDiv.textContent = numbers[i];
                }
                fretNumbersContainer.appendChild(numDiv);
            }
            area.appendChild(fretNumbersContainer);
            container.appendChild(area);
        };

        const updateFretboard = (containerId, rootNote, scaleNotes, preferredNotes) => {
            document.querySelectorAll(`#${containerId} .note-fixed, #${containerId} .open-string-name`).forEach(el => el.classList.remove('in-scale', 'root'));

            const scaleNoteIndices = scaleNotes.map(noteNameToIndex);
            const rootNoteIndex = noteNameToIndex(rootNote);
            const reversedTuning = [...guitarTuning].reverse();

            for (let string = 0; string < 6; string++) {
                const openNoteIndex = reversedTuning[string];
                if (scaleNoteIndices.includes(openNoteIndex % 12)) {
                    const openStringLabel = document.querySelector(`#${containerId} .open-string-name:nth-child(${string + 1})`);
                    if (openStringLabel) {
                        openStringLabel.classList.add('in-scale');
                        if (openNoteIndex % 12 === rootNoteIndex) openStringLabel.classList.add('root');
                    }
                }
                
                const stringDiv = document.querySelector(`#${containerId} .fretboard .string:nth-child(${string + 1})`);
                if (!stringDiv) continue;

                const frets = stringDiv.querySelectorAll('.fret:not(.nut)');
                frets.forEach((fretDiv, fretIndex) => {
                    const currentNoteIndex = (openNoteIndex + fretIndex + 1) % 12;
                    const noteEl = fretDiv.querySelector('.note-fixed');
                    if (noteEl) {
                       noteEl.textContent = preferredNotes[currentNoteIndex];
                       if (scaleNoteIndices.includes(currentNoteIndex)) {
                           noteEl.classList.add('in-scale');
                           if (currentNoteIndex === rootNoteIndex) noteEl.classList.add('root');
                       }
                    }
                });
            }
        };

        const renderSimpleMode = () => {
            const rootNote = rootNoteSelect.value;
            const chordType = chordTypeSelect.value;
            if (!rootNote || !chordType) {
                simpleModeContent.classList.add('hidden');
                return;
            }
            simpleModeContent.classList.remove('hidden');
            tableBody.innerHTML = '';
            const relations = pentatonicToChordRelations[chordType] || [];
            const preferredNotes = getPreferredNotes(rootNote, chordType);
            relations.forEach(rel => {
                const pentatonicRootIndex = rel.pentatonicRoot(noteNameToIndex(rootNote));
                const pentatonicRoot = preferredNotes[pentatonicRootIndex];
                
                let pentatonicNotes = pentatonicFormulas[rel.type].map(interval => getNoteFromInterval(pentatonicRoot, interval, preferredNotes));
                const degrees = pentatonicNotes.map(note => getIntervalName(rootNote, note, chordType));
                
                const arpeggios = getArpeggiosForPentatonic(pentatonicNotes, rel.type);
                const triadasHtml = `<td data-arpeggios='${JSON.stringify(arpeggios.triadas)}'><div class="example-box">${arpeggios.triadas.join('\n')}</div></td>`;
                const tetradasHtml = `<td data-arpeggios='${JSON.stringify(arpeggios.tetradas)}'><div class="example-box">${arpeggios.tetradas.join('\n')}</div></td>`;

                const row = document.createElement('tr');
                row.dataset.notes = pentatonicNotes.join(',');
                row.dataset.root = pentatonicRoot;
                row.dataset.type = rel.type;
                const displayName = PENTATONIC_DISPLAY_NAMES[rel.type] || rel.type;

                row.innerHTML = `
                    <td>
                        <div class="font-bold text-lg">${pentatonicRoot} <span class="text-sm text-gray-400">${displayName}</span></div>
                        <div class="text-xs mt-1">${pentatonicNotes.join(', ')}</div>
                    </td>
                    ${triadasHtml}
                    ${tetradasHtml}
                    <td><div class="example-box">${degrees.join(', ')}</div></td>
                    <td>${rel.logic}</td>
                `;
                row.addEventListener('click', (e) => {
                    document.querySelectorAll('#scale-table-body tr').forEach(r => r.classList.remove('selected-row'));
                    const clickedRow = e.currentTarget;
                    clickedRow.classList.add('selected-row');
                    updateFretboardAndArpeggios(clickedRow);
                     // Clear melody when changing selected scale
                    randomMelodyPart = [];
                    arpeggioMelodyPart = [];
                    updateMelodyDisplay();
                });
                tableBody.appendChild(row);
            });
            if (tableBody.firstChild) tableBody.firstChild.click();
        };

        const updateFretboardAndArpeggios = (row) => {
            const currentRoot = row.dataset.root;
            const currentNotes = row.dataset.notes.split(',');
            const hasSharp = currentNotes.some(n => n.includes('#') && !n.includes('b'));
            const currentPreferred = hasSharp ? SHARP_NOTES : FLAT_NOTES;
            updateFretboard('fretboard-container-simple', currentRoot, currentNotes, currentPreferred);
            populateArpeggioSelector();
        };

        const fillSelects = () => {
            Object.keys(KEY_SIGNATURES).forEach(note => {
                rootNoteSelect.innerHTML += `<option value="${note}">${note}</option>`;
            });
            Object.keys(chordTypes).forEach(type => {
                chordTypeSelect.innerHTML += `<option value="${type}">${chordTypes[type]}</option>`;
            });
            rootNoteSelect.value = 'C';
            chordTypeSelect.value = 'maj7';
        };

        const setupEventListeners = () => {
            const allButtons = document.querySelectorAll('button, select');
            allButtons.forEach(btn => {
                btn.addEventListener('click', async () => {
                    if (!isToneStarted) {
                        await Tone.start();
                        isToneStarted = true;
                    }
                });
            });

            rootNoteSelect.addEventListener('change', () => {
                randomMelodyPart = [];
                arpeggioMelodyPart = [];
                updateMelodyDisplay();
                renderSimpleMode();
            });
            chordTypeSelect.addEventListener('change', () => {
                randomMelodyPart = [];
                arpeggioMelodyPart = [];
                updateMelodyDisplay();
                renderSimpleMode();
            });

            document.getElementById('stop-melody-btn').addEventListener('click', stopPlayback);
            
            document.getElementById('enharmonic-btn').addEventListener('click', () => {
                const selectedRow = document.querySelector('#scale-table-body .selected-row');
                if (!selectedRow) return;

                const currentNotes = selectedRow.dataset.notes.split(',').map(note => ENHARMONIC_MAP[note] || note);
                const currentRoot = ENHARMONIC_MAP[selectedRow.dataset.root] || selectedRow.dataset.root;
                const type = selectedRow.dataset.type;

                selectedRow.dataset.notes = currentNotes.join(',');
                selectedRow.dataset.root = currentRoot;

                const displayName = PENTATONIC_DISPLAY_NAMES[type] || type;
                selectedRow.querySelector('.font-bold').innerHTML = `${currentRoot} <span class="text-sm text-gray-400">${displayName}</span>`;
                selectedRow.querySelector('.text-xs').textContent = currentNotes.join(', ');
                
                const arpeggios = getArpeggiosForPentatonic(currentNotes, type);
                const cells = selectedRow.getElementsByTagName('td');
                cells[1].dataset.arpeggios = JSON.stringify(arpeggios.triadas);
                cells[1].querySelector('.example-box').textContent = arpeggios.triadas.join('\n');
                cells[2].dataset.arpeggios = JSON.stringify(arpeggios.tetradas);
                cells[2].querySelector('.example-box').textContent = arpeggios.tetradas.join('\n');
                
                updateFretboardAndArpeggios(selectedRow);
            });
            
            // Metronome Listener
            bpmSlider.addEventListener('input', (e) => {
                const newBpm = e.target.value;
                Tone.Transport.bpm.value = newBpm;
                bpmValue.textContent = `${newBpm} BPM`;
            });

            // Generator Logic
            arpeggioTypeSelect.addEventListener('change', populateArpeggioSelector);
            document.getElementById('add-arpeggio-btn').addEventListener('click', addArpeggioToMelody);
            document.getElementById('play-melody-btn').addEventListener('click', playMelody);
            document.getElementById('play-arpeggios-btn').addEventListener('click', playArpeggios);
            document.getElementById('clear-melody-btn').addEventListener('click', () => {
                randomMelodyPart = [];
                arpeggioMelodyPart = [];
                updateMelodyDisplay();
            });
            document.getElementById('add-random-btn').addEventListener('click', addRandomNotesToMelody);
        };

        function populateArpeggioSelector() {
            const selectedRow = document.querySelector('#scale-table-body .selected-row');
            arpeggioSelect.innerHTML = '';
            if (!selectedRow) return;

            const type = arpeggioTypeSelect.value;
            const cellIndex = type === 'triads' ? 1 : 2;
            const arpeggioCell = selectedRow.cells[cellIndex];
            
            if (arpeggioCell && arpeggioCell.dataset.arpeggios) {
                const arpeggios = JSON.parse(arpeggioCell.dataset.arpeggios);
                arpeggios.forEach(arpString => {
                    const option = document.createElement('option');
                    option.value = arpString;
                    option.textContent = arpString.trim();
                    arpeggioSelect.appendChild(option);
                });
            }
        }
        
        function updateMelodyDisplay() {
            const fullMelody = [...randomMelodyPart, ...arpeggioMelodyPart];
            if (fullMelody.length > 0) {
                generatorOutput.textContent = fullMelody.join(' - ');
            } else {
                generatorOutput.textContent = '';
            }
        }

        function addArpeggioToMelody() {
            const arpString = arpeggioSelect.value;
            if (!arpString) return;
            
            let arpeggioNotes = arpString.split(':')[1].trim().split(', ');
            const randomOrderCheckbox = document.getElementById('arpeggio-random-order');
            
            if(randomOrderCheckbox.checked) {
                arpeggioNotes = [...arpeggioNotes].sort(() => 0.5 - Math.random());
            }

            arpeggioMelodyPart = arpeggioNotes;
            updateMelodyDisplay();
        }

        function playMelody() {
            stopPlayback();
            const fullMelody = [...randomMelodyPart, ...arpeggioMelodyPart];
            if (fullMelody.length === 0) return;

            const melodyString = fullMelody.join(' - ');
            const notes = fullMelody;
            const notesWithOctaves = assignOctaves(notes);
            const rhythm = rhythmSelect.value;
            
            // Re-render the output with spans for highlighting
            generatorOutput.innerHTML = '';
            notes.forEach((note, index) => {
                const noteSpan = document.createElement('span');
                noteSpan.id = `melody-note-${index}`;
                noteSpan.className = 'note-span';
                noteSpan.textContent = note;
                generatorOutput.appendChild(noteSpan);

                if (index < notes.length - 1) {
                    const separator = document.createTextNode(' - ');
                    generatorOutput.appendChild(separator);
                }
            });
             
            // Create an array of indices to pass to the sequence
            const indices = Array.from(Array(notes.length).keys());

            const sequence = new Tone.Sequence((time, index) => {
                const note = notes[index];
                const noteWithOctave = notesWithOctaves[index];
                melodySynth.triggerAttackRelease(noteWithOctave, rhythm, time);
                
                // Highlight fretboard
                Tone.Draw.schedule(() => {
                    highlightNote(note, 'add', Tone.Time(rhythm).toMilliseconds());
                }, time);

                // Highlight text span
                Tone.Draw.schedule(() => {
                    const noteSpan = document.getElementById(`melody-note-${index}`);
                    if (noteSpan) {
                        noteSpan.classList.add('playing');
                        setTimeout(() => {
                            noteSpan.classList.remove('playing');
                        }, Tone.Time(rhythm).toMilliseconds());
                    }
                }, time);

            }, indices, rhythm);
            
            sequence.loop = false;
            sequence.start(0);

            const duration = notes.length * Tone.Time(rhythm).toSeconds();
            // Add a small buffer to ensure the last note finishes
            Tone.Transport.scheduleOnce(() => {
                stopPlayback();
                 // After playback, restore the simple text content
                generatorOutput.textContent = melodyString;
            }, duration + 0.1);

            Tone.Transport.start();
        }
        
        function playArpeggios() {
            stopPlayback();
            const selectedRow = document.querySelector('#scale-table-body .selected-row');
            if (!selectedRow) return;

            const type = arpeggioTypeSelect.value;
            const cellIndex = type === 'triads' ? 1 : 2;
            const arpeggioCell = selectedRow.cells[cellIndex];
            if (!arpeggioCell || !arpeggioCell.dataset.arpeggios) return;

            const arpeggiosRaw = JSON.parse(arpeggioCell.dataset.arpeggios);
            const arpeggiosNotes = arpeggiosRaw.map(arp => arp.split(':')[1].trim().split(', '));
            const rhythm = rhythmSelect.value;
            
            const sequenceNotes = [];
            arpeggiosNotes.forEach(arp => {
                sequenceNotes.push(...arp);
                sequenceNotes.push(null); // Rest between arpeggios
            });

            const notesWithOctaves = assignOctaves(sequenceNotes);
            const indices = Array.from(Array(sequenceNotes.length).keys());
            
            const sequence = new Tone.Sequence((time, index) => {
                const noteWithOctave = notesWithOctaves[index];
                if (noteWithOctave) {
                    const noteName = sequenceNotes[index];
                    melodySynth.triggerAttackRelease(noteWithOctave, rhythm, time);
                    Tone.Draw.schedule(() => {
                        highlightNote(noteName, 'add', Tone.Time(rhythm).toMilliseconds());
                    }, time);
                }
            }, indices, rhythm);
            sequence.loop = false;
            sequence.start(0);

            const duration = sequenceNotes.length * Tone.Time(rhythm).toSeconds();
            // Add a small buffer to ensure the last note finishes
            Tone.Transport.scheduleOnce(() => {
                stopPlayback();
            }, duration + 0.1);

            Tone.Transport.start();
        }

        function addRandomNotesToMelody() {
            const selectedRow = document.querySelector('#scale-table-body .selected-row');
            if (!selectedRow) {
                generatorOutput.textContent = "Selecciona una escala primero.";
                setTimeout(() => { if (generatorOutput.textContent === "Selecciona una escala primero.") generatorOutput.textContent = "" }, 2000);
                return;
            }

            const scaleNotes = selectedRow.dataset.notes.split(',');
            const count = parseInt(document.getElementById('random-note-count').value, 10);
            
            if (isNaN(count) || count < 1 || count > 5) {
                generatorOutput.textContent = "Número de notas debe ser entre 1 y 5.";
                setTimeout(() => { if (generatorOutput.textContent === "Número de notas debe ser entre 1 y 5.") generatorOutput.textContent = "" }, 2000);
                return;
            }

            const shuffled = [...scaleNotes].sort(() => 0.5 - Math.random());
            randomMelodyPart = shuffled.slice(0, count);
            updateMelodyDisplay();
        }

        function highlightNote(note, action, duration) {
            const noteElements = document.querySelectorAll(`#fretboard-container-simple .note-fixed`);
            const openStringElements = document.querySelectorAll(`#fretboard-container-simple .open-string-name`);
            const allElements = [...noteElements, ...openStringElements];

            allElements.forEach(el => {
                if (el.textContent === note) {
                    if (action === 'add') {
                        el.classList.add('playing');
                        setTimeout(() => el.classList.remove('playing'), duration);
                    } else {
                         el.classList.remove('playing');
                    }
                }
            });
        }
        
        // --- START APP ---
        fillSelects();
        createFretboard('fretboard-container-simple');
        setupEventListeners();
        Tone.Transport.bpm.value = bpmSlider.value; // Set initial BPM
        renderSimpleMode(); 
    });
    </script>
</body>
</html>

