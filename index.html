<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laboratorio de Lenguaje de Jazz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep-night: #121826;
            --bg-panel: #1E293B;
            --text-main: #E2E8F0;
            --accent-gold: #FBBF24;
            --accent-cyan: #22D3EE;
            --border-steel: #475569;
            --text-dark: #1E293B;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-deep-night); color: var(--text-main); }
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s ease-in-out; border: 2px solid transparent; cursor: pointer; }
        .btn-primary { background-color: var(--accent-gold); color: var(--text-dark); border-color: var(--accent-gold); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 20px -5px var(--accent-gold); }
        .btn-secondary { background-color: transparent; color: var(--text-main); border-color: var(--border-steel); }
        .btn-secondary:hover { background-color: var(--border-steel); }
        .btn-secondary.active-metronome { background-color: var(--accent-cyan); color: var(--text-dark); border-color: var(--accent-cyan); }
        .btn-stop { background-color: #ef4444; color: white; border-color: #ef4444; }
        .btn-stop:hover { transform: translateY(-2px); box-shadow: 0 4px 20px -5px #ef4444; }
        .piano-container { position: relative; height: 80px; }
        .piano-key { position: absolute; border: 1px solid #4b5563; border-radius: 0 0 8px 8px; box-shadow: inset 0 -3px 4px rgba(0,0,0,0.25); transition: all 0.1s ease; }
        .white-key { background-image: linear-gradient(to bottom, #f3f4f6, #d1d5db); height: 100%; z-index: 1; }
        .black-key { background-image: linear-gradient(to bottom, #374151, #111827); height: 60%; width: 3%; z-index: 2; }
        .key-highlight-approach { background-image: none; background-color: var(--accent-cyan); box-shadow: 0 0 10px var(--accent-cyan); }
        .key-highlight-target { background-image: none; background-color: var(--accent-gold); box-shadow: 0 0 12px var(--accent-gold); }
        .control-panel select, .control-panel input[type="range"] { background-color: var(--bg-deep-night); border: 1px solid var(--border-steel); border-radius: 0.5rem; }
        .combination-label { cursor: pointer; display: block; padding: 0.5rem 1rem; border-radius: 0.5rem; transition: background-color 0.2s; border: 1px solid var(--border-steel); }
        .combination-label:hover { background-color: var(--border-steel); }
        .combination-input:checked + .combination-label, .combination-label.highlight { background-color: var(--accent-gold); color: var(--text-dark); border-color:var(--accent-gold); font-weight: 600; }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
        .note-display { min-height: 3rem; background-color: var(--bg-deep-night); border-radius: 0.5rem; padding: 0.5rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-family: monospace; font-size: 1.5rem; border: 1px solid var(--border-steel); }
        .note-display .font-bold { color: var(--accent-gold); }
        .tab { padding: 8px 16px; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s; }
        .tab.active { border-bottom-color: var(--accent-gold); color: var(--accent-gold); }
        .progression-chord { padding: 1rem; border: 2px solid var(--border-steel); border-radius: 0.75rem; transition: all 0.2s; cursor: pointer; }
        .progression-chord.active { border-color: var(--accent-gold); background-color: var(--bg-panel); transform: scale(1.05); }
        .favorite-star { cursor: pointer; color: var(--border-steel); transition: color 0.2s; user-select: none; font-size: 1.25rem; }
        .favorite-star.favorited { color: var(--accent-gold); }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(18, 24, 38, 0.8); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 50; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-content { background-color: var(--bg-panel); color: var(--text-main); padding: 2rem; border-radius: 1rem; width: 90%; max-width: 800px; max-height: 80vh; overflow-y: auto; transform: scale(0.95); transition: transform 0.3s ease; position: relative; border: 1px solid var(--border-steel); }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-close-btn { position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: var(--border-steel); font-size: 1.5rem; cursor: pointer; }
        .modal-close-btn:hover { color: var(--text-main); }
        .prose { color: var(--text-main); }
        .prose h1, .prose h2, .prose h3 { color: white; }
        .prose strong { color: var(--accent-gold); }
        .prose code { background-color: var(--bg-deep-night); color: var(--accent-cyan); padding: 0.2em 0.4em; border-radius: 0.3em; }
        .prose a { color: var(--accent-cyan); }
        .prose ul > li::before { background-color: var(--accent-gold); }
        .prose .interactive-sigla { background-color: var(--bg-deep-night); color: var(--accent-cyan); padding: 0.3em 0.6em; border-radius: 0.4em; cursor: pointer; border: 1px solid var(--border-steel); transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.5rem; }
        .prose .interactive-sigla:hover { background-color: var(--accent-cyan); color: var(--bg-deep-night); border-color: var(--accent-cyan); }
        .tour-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 99; display: none; }
        .tour-popover { position: absolute; background-color: var(--bg-panel); padding: 1.5rem; border-radius: 0.75rem; z-index: 100; width: 300px; border: 1px solid var(--border-steel); box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: none; transition: top 0.3s ease, left 0.3s ease; }
        .tour-highlight { z-index: 100; box-shadow: 0 0 0 4px var(--accent-gold); border-radius: 0.5rem; transition: box-shadow 0.3s; position: relative; }
        .target-button.highlight-target { background-color: var(--accent-gold); color: var(--text-dark); transform: scale(1.1); }
    </style>
</head>
<body class="bg-[#121826] text-[#E2E8F0]">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-4">
            <h1 class="text-4xl md:text-5xl font-extrabold text-white mb-2 tracking-wide">Laboratorio de Lenguaje de Jazz</h1>
            <p class="text-lg text-[#94a3b8]">Un Estudio Pr√°ctico de las Aproximaciones Crom√°ticas y Diat√≥nicas</p>
            <p class="text-sm text-[#94a3b8] italic mt-2">Creado por: <strong>Juan Miguel R√≠os Redondo</strong></p>
        </header>
        
        <div class="flex justify-center gap-4 mb-8">
            <button id="tutorial-btn" class="btn btn-secondary text-sm">Tour Guiado</button>
            <button id="glossary-btn" class="btn btn-secondary text-sm">Glosario Interactivo</button>
        </div>

        <div class="flex justify-center border-b border-[#475569] mb-8">
            <div id="tab-lab" class="tab active">Laboratorio de Pr√°ctica</div>
            <div id="tab-ear-trainer" class="tab">Entrenamiento Auditivo</div>
        </div>

        <div id="app-content">
            <div id="practice-lab-view">
                <div id="control-panel-tour" class="control-panel bg-[#1E293B] p-6 rounded-xl mb-8 shadow-2xl">
                    <div id="audio-status" class="w-full text-center text-sm font-bold p-2 rounded-lg bg-red-800/50 text-red-200 border border-red-600 mb-6 transition-colors">AUDIO EN PAUSA - HAZ CLIC EN CUALQUIER LUGAR PARA ACTIVAR</div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div id="mode-tour"><label for="practice-mode" class="text-sm font-medium">Modo:</label><select id="practice-mode" class="w-full p-2 mt-1"></select></div>
                        <div id="progression-type-tour" class="hidden"><label for="progression-type" class="text-sm font-medium">Tipo de Progresi√≥n:</label><select id="progression-type" class="w-full p-2 mt-1"></select></div>
                        <div id="tonality-tour"><label for="tonality-selector" class="text-sm font-medium">Tonalidad:</label><select id="tonality-selector" class="w-full p-2 mt-1"></select></div>
                        <div id="root-tour"><label for="root-note" class="text-sm font-medium">Ra√≠z (T√≥nica):</label><select id="root-note" class="w-full p-2 mt-1"></select></div>
                        <div id="chord-tour"><label for="chord-type" class="text-sm font-medium">Tipo de Acorde:</label><select id="chord-type" class="w-full p-2 mt-1"></select></div>
                        <div id="scale-tour"><label for="scale-type" class="text-sm font-medium">Escala Relacionada:</label><select id="scale-type" class="w-full p-2 mt-1"></select></div>
                        <div id="sound-tour"><label for="synth-sound" class="text-sm font-medium">Sonido:</label><select id="synth-sound" class="w-full p-2 mt-1"></select></div>
                    </div>
                    <div class="border-t border-[#475569] mt-6 pt-6">
                        <div id="metronome-controls-tour" class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                             <div class="md:col-span-1">
                                <label for="tempo-slider" class="text-sm font-medium">Tempo: <span id="tempo-display">120</span> BPM</label>
                                <input type="range" id="tempo-slider" min="40" max="240" value="120" class="w-full mt-2 h-2 bg-[#121826] rounded-lg appearance-none cursor-pointer">
                            </div>
                            <div class="md:col-span-1">
                                <label for="rhythm-selector" class="text-sm font-medium">Ritmo:</label>
                                <select id="rhythm-selector" class="w-full p-2 mt-1">
                                    <option value="swing">Swing (Tresillos)</option>
                                    <option value="straight">Recto (Corcheas)</option>
                                </select>
                            </div>
                            <div class="md:col-span-1 space-y-3">
                                <div>
                                    <label for="metronome-volume" class="text-xs font-medium">Volumen Metr√≥nomo: <span id="metro-vol-display">0</span> dB</label>
                                    <input type="range" id="metronome-volume" min="-40" max="6" value="0" class="w-full h-2 bg-[#121826] rounded-lg appearance-none cursor-pointer">
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <select id="metronome-accent" class="w-full p-2 text-sm">
                                        <option value="-1">Apagado</option>
                                        <option value="0">Sin Acento</option>
                                        <option value="2">Cada 2</option>
                                        <option value="3">Cada 3</option>
                                        <option value="4" selected>Cada 4</option>
                                    </select>
                                    <button id="metronome-toggle" class="btn btn-secondary w-full text-sm py-2">Metr√≥nomo</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="progression-play-btn-container" class="flex justify-end mt-4">
                       <button id="progression-play-btn" class="btn btn-primary hidden w-full md:w-auto">‚ñ∂Ô∏è Play</button>
                    </div>
                </div>
                <div id="progression-view-container" class="hidden mb-8 grid grid-cols-3 gap-4 text-center"></div>
                <div id="approach-group-tour" class="bg-[#1E293B] p-4 rounded-xl mb-6"><label for="approach-group" class="text-sm font-medium mr-2">Grupo de Aproximaciones:</label><select id="approach-group" class="p-2 rounded-lg text-white bg-[#121826] border border-[#475569]"></select></div>
                <div id="combination-selector-container" class="my-6"></div>
                <div id="play-all-container" class="text-center mb-8"></div>
                <main id="approach-card-container" class="flex justify-center"></main>
            </div>
            <div id="ear-trainer-view" class="hidden text-center">
                 <div class="bg-[#1E293B] p-8 rounded-xl max-w-2xl mx-auto shadow-2xl">
                    <h2 class="text-3xl font-bold mb-4">Entrenamiento Auditivo</h2>
                    <p class="text-[#94a3b8] mb-8">Escucha la aproximaci√≥n y adivina cu√°l es.</p>
                    <div class="flex justify-around items-center mb-8 text-lg">
                        <div>Puntaje: <span id="ear-trainer-score" class="font-bold text-green-400">0</span></div>
                        <div>Intentos: <span id="ear-trainer-attempts" class="font-bold text-cyan-400">0</span></div>
                    </div>
                    <button id="ear-trainer-listen-btn" class="btn btn-primary text-lg">üéµ Escuchar y Jugar</button>
                    <div id="ear-trainer-options" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-8"></div>
                    <p id="ear-trainer-feedback" class="mt-6 h-6 font-semibold"></p>
                </div>
            </div>
        </div>

        <footer class="text-center mt-16 text-[#64748b] text-sm">
        </footer>
    </div>
    
    <div id="glossary-modal" class="modal-overlay"><div class="modal-content prose"><button class="modal-close-btn">&times;</button></div></div>
    <div id="tour-overlay" class="tour-overlay"></div>
    <div id="tour-popover" class="tour-popover"><div id="tour-content" class="mb-4"></div><div class="flex justify-between items-center"><button id="tour-prev" class="btn btn-secondary text-sm">Anterior</button><span id="tour-step-indicator" class="text-sm text-[#94a3b8]"></span><button id="tour-next" class="btn btn-primary text-sm">Siguiente</button></div><button id="tour-close" class="modal-close-btn">&times;</button></div>

<script>
    // --- DATA ---
    const MIDI_TO_SHARP=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B']; const MIDI_TO_FLAT=['C','Db','D','Eb','E','F','Gb','G','Ab','A','Bb','B']; const NOTE_LETTERS=['C','D','E','F','G','A','B']; const ROOT_NOTES={'#':['C','G','D','A','E','B','F#'],'b':['F','Bb','Eb','Ab','Db','Gb']}; const CHORD_FORMULAS={'maj7':{name:'Major 7',intervals:[0,4,7,11]},'m7':{name:'Minor 7',intervals:[0,3,7,10]},'7':{name:'Dominant 7',intervals:[0,4,7,10]},'m7b5':{name:'Half-Diminished',intervals:[0,3,6,10]}}; 
    const SCALE_FORMULAS={'ionian':{name:'J√≥nica (Mayor)',intervals:[0,2,4,5,7,9,11]},'lydian':{name:'Lidia',intervals:[0,2,4,6,7,9,11]},'dorian':{name:'D√≥rica',intervals:[0,2,3,5,7,9,10]},'aeolian':{name:'E√≥lica (Menor Natural)',intervals:[0,2,3,5,7,8,10]},'phrygian':{name:'Frigia',intervals:[0,1,3,5,7,8,10]},'mixolydian':{name:'Mixolidia',intervals:[0,2,4,5,7,9,10]},'lydianDominant':{name:'Mixolidio #11 (Lidia b7)',intervals:[0,2,4,6,7,9,10]},'locrian':{name:'Locria',intervals:[0,1,3,5,6,8,10]}, 'altered': {name: 'Alterada (Super Locria)', intervals:[0, 1, 3, 4, 6, 8, 10]}}; 
    const CHORD_TO_SCALE_MAP={'maj7':['ionian','lydian'],'m7':['dorian','aeolian','phrygian'],'7':['mixolydian','lydianDominant', 'altered'],'m7b5':['locrian']};
    const APPROACH_DEFINITIONS = { "Favoritos": [], "1 Nota": [ {id:"1-0", name:"Crom√°tico Abajo (CB)", code:['CB']}, {id:"1-1", name:"Crom√°tico Arriba (CA)", code:['CA']}, {id:"1-2", name:"Escala Arriba (SA)", code:['SA']}, {id:"1-3", name:"Escala Abajo (SB)", code:['SB']} ], "2 Notas": [ {id:"2-0", name:"Escala Arriba, Crom√°tico Abajo (SA, CB)", code:['SA', 'CB']}, {id:"2-1", name:"Crom√°tico Abajo, Escala Arriba (CB, SA)", code:['CB', 'SA']}, {id:"2-2", name:"Doble Crom√°tico Abajo (DCB)", code:['DCB']}, {id:"2-3", name:"Doble Crom√°tico Arriba (DCA)", code:['DCA']} ], "3 Notas": [ {id:"3-0", name:"Doble Crom. Abajo, Escala Arriba (DCB, SA)", code:['DCB', 'SA']}, {id:"3-1", name:"Escala Arriba, Doble Crom. Abajo (SA, DCB)", code:['SA', 'DCB']}, {id:"3-2", name:"Encierro (SA, DCB, SA)", code:['SA', 'DCB', 'SA']}, {id:"3-3", name:"Encierro (CB, DCA, CB)", code:['CB', 'DCA', 'CB']} ], "4 Notas (Encierros)": [ {id:"4-0", name:"Doble Crom. Abajo, Doble Crom. Arriba (DCB, DCA)", code:['DCB', 'DCA']}, {id:"4-1", name:"Doble Crom. Arriba, Doble Crom. Abajo (DCA, DCB)", code:['DCA', 'DCB']}, {id:"4-2", name:"Encierro (DCB, SA, CB)", code:['DCB', 'SA', 'CB']} ], "4 Notas (Est. Constante)": [ {id:"4-3", name:"T+ T- C+ C-", code:['WA','WB','CA','CB']}, {id:"4-4", name:"T+ T- C- C+", code:['WA','WB','CB','CA']}, {id:"4-5", name:"T- T+ C- C+", code:['WB','WA','CB','CA']}, {id:"4-6", name:"T- T+ C+ C-", code:['WB','WA','CA','CB']} ], "5 Notas": [ {id:"5-0", name:"(DCB, DCA, CB)", code:['DCB', 'DCA', 'CB']}, {id:"5-1", name:"(DCA, DCB, CA)", code:['DCA', 'DCB', 'CA']}, {id:"5-2", name:"(CA, CB) x2 + CA", code:['CA', 'CB', 'CA', 'CB', 'CA']}, {id:"5-3", name:"(CB, CA) x2 + CB", code:['CB', 'CA', 'CB', 'CA', 'CB']} ] };

    // --- GLOBAL STATE ---
    let synth, chordSynth, bassSynth, metroAccent, metroClick, metroVolumeNode, metronomeSequence, progressionLoop;
    let isAudioReady = false, isPlaying = false, isPlayingAll = false, forceStopPlayAll = false;
    let currentTonality = '#';
    let favorites = [];
    let earTrainerState = {};
    let activeProgressionChordIndex = 0;
    
    // --- CORE LOGIC ---
    const getMidiFromNoteName = (noteName) => { const name=noteName.slice(0,-1); const oct=parseInt(noteName.slice(-1)); let midi=MIDI_TO_SHARP.indexOf(name); if(midi===-1)midi=MIDI_TO_FLAT.indexOf(name); return midi+(oct+1)*12; }
    const getNoteWithOctave = (midi, scale, direction=null) => { const matchingScaleNote=scale.find(note=>getMidiFromNoteName(note)%12===midi%12); if(matchingScaleNote){return `${matchingScaleNote.slice(0,-1)}${Math.floor(midi/12)-1}`;} const noteSet=direction==='#'?MIDI_TO_SHARP:direction==='b'?MIDI_TO_FLAT:(currentTonality==='b'?MIDI_TO_FLAT:MIDI_TO_SHARP); return `${noteSet[midi%12]}${Math.floor(midi/12)-1}`; };
    function getApproachSequence(combinationCode, targetNote, scale) { const targetMidi = getMidiFromNoteName(targetNote); const scaleMidi = scale.map(getMidiFromNoteName).sort((a, b) => a - b); const sequence = []; const getDiatonic = (startMidi, direction) => { if (direction > 0) return scaleMidi.find(m => m > startMidi) || (scaleMidi[0] + 12); return scaleMidi.slice().reverse().find(m => m < startMidi) || (scaleMidi[scaleMidi.length - 1] - 12); }; for (const op of combinationCode) { switch (op) { case 'CB': sequence.push(getNoteWithOctave(targetMidi - 1, scale, '#')); break; case 'CA': sequence.push(getNoteWithOctave(targetMidi + 1, scale, 'b')); break; case 'WB': sequence.push(getNoteWithOctave(targetMidi - 2, scale, '#')); break; case 'WA': sequence.push(getNoteWithOctave(targetMidi + 2, scale, 'b')); break; case 'SB': sequence.push(getNoteWithOctave(getDiatonic(targetMidi, -1), scale)); break; case 'SA': sequence.push(getNoteWithOctave(getDiatonic(targetMidi, 1), scale)); break; case 'DCB': sequence.push(getNoteWithOctave(targetMidi - 2, scale, '#'), getNoteWithOctave(targetMidi - 1, scale, '#')); break; case 'DCA': sequence.push(getNoteWithOctave(targetMidi + 2, scale, 'b'), getNoteWithOctave(targetMidi + 1, scale, 'b')); break; } } return sequence; }
    function buildScale(rootNoteName, intervals) { const rootMidi=getMidiFromNoteName(`${rootNoteName}4`); const rootLetter=rootNoteName.charAt(0); const rootLetterIndex=NOTE_LETTERS.indexOf(rootLetter); return intervals.map((interval,i)=>{const targetMidi=rootMidi+interval;const targetLetter=NOTE_LETTERS[(rootLetterIndex+i)%7];const noteSet=currentTonality==='b'?MIDI_TO_FLAT:MIDI_TO_SHARP;let correctName=noteSet[targetMidi%12];for(const name of [MIDI_TO_SHARP[targetMidi%12],MIDI_TO_FLAT[targetMidi%12]]){if(name.charAt(0)===targetLetter){correctName=name;break;}}return `${correctName}4`;}); }

    // --- AUDIO & UI ---
    function initAudio() { if (isAudioReady) return; Tone.start().then(() => { isAudioReady = true; const synthOpts = { volume: -6, envelope: { attack: 0.01, decay: 0.3, sustain: 0.2, release: 0.5 } }; synth = new Tone.PolySynth(Tone.Synth, synthOpts).toDestination(); chordSynth = new Tone.PolySynth(Tone.Synth, { volume: -15, envelope: { attack: 0.05, release: 0.5 } }).toDestination(); bassSynth = new Tone.Synth({ volume: -8, oscillator: { type: 'sine' }, envelope: { attack: 0.01, release: 0.4 } }).toDestination(); metroVolumeNode = new Tone.Volume(0).toDestination(); const metroOpts = { harmonicity: 8, modulationIndex: 2, envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 } }; metroAccent = new Tone.FMSynth({...metroOpts, volume: -2}).connect(metroVolumeNode); metroClick = new Tone.FMSynth({...metroOpts, volume: -8}).connect(metroVolumeNode); progressionLoop = new Tone.Loop(time => { const progressionChords = document.querySelectorAll('.progression-chord'); if (progressionChords.length > 0) { activeProgressionChordIndex = (activeProgressionChordIndex + 1) % progressionChords.length; Tone.Draw.schedule(() => { progressionChords.forEach((c, i) => c.classList.toggle('active', i === activeProgressionChordIndex)); renderActiveApproachCard(); }, time); } }, "1m"); Tone.Transport.bpm.value = 120; changeSynth(document.getElementById('synth-sound').value); const audioStatus = document.getElementById('audio-status'); audioStatus.textContent = "AUDIO ACTIVADO"; audioStatus.classList.replace('bg-red-800/50', 'bg-green-800/50'); audioStatus.classList.replace('border-red-600', 'border-green-500'); audioStatus.classList.replace('text-red-200', 'text-green-200'); }); }
    function changeSynth(soundType) { if (!isAudioReady || !synth) return; const opts = { rhodes:{oscillator:{type:'fmsine', modulationIndex: 10, harmonicity: 2}}, synth:{oscillator:{type:'sawtooth'}}, fmsine:{oscillator:{type:'fmsine'}} }; synth.set(opts[soundType]); }
    async function playSequence(approachNotes, targetNote, card, chordRoot) { if (!isAudioReady || isPlaying) return; isPlaying = true; try { const pianoContainer = card.querySelector('.piano-container'); const noteDisplay = card.querySelector('.note-display'); if (noteDisplay) noteDisplay.innerHTML = ''; const allNotes = [...approachNotes, targetNote]; const noteDuration = document.getElementById('rhythm-selector').value === 'swing' ? '8t' : '8n'; const noteDurationSec = Tone.Time(noteDuration).toSeconds(); if (chordRoot) { const chordType = card.dataset.chordType || 'maj7'; const chordFormula = CHORD_FORMULAS[chordType]; const chordTones = chordFormula.intervals.map(i => getNoteWithOctave(getMidiFromNoteName(chordRoot + '3') + i, [])); bassSynth.triggerAttackRelease(chordRoot + '2', '4n'); chordSynth.triggerAttackRelease(chordTones, '4n'); } for (let i = 0; i < allNotes.length; i++) { if (forceStopPlayAll) { if (synth) synth.releaseAll(); return; } const note = allNotes[i]; const isTarget = i === allNotes.length - 1; const timeOffset = document.getElementById('rhythm-selector').value === 'swing' && i % 2 !== 0 ? noteDurationSec * 0.5 : 0; if (synth) synth.triggerAttackRelease(note, noteDuration, Tone.now() + timeOffset); let key; if (pianoContainer) { key = pianoContainer.querySelector(`[data-note="${note}"]`); if (!key) key = pianoContainer.querySelector(`[data-note-flat="${note}"]`); } if (key) { const cssClass = isTarget ? 'key-highlight-target' : 'key-highlight-approach'; key.classList.add(cssClass); setTimeout(() => key.classList.remove(cssClass), noteDurationSec * 900); } if (noteDisplay) { const noteSpan = document.createElement('span'); noteSpan.textContent = note.slice(0, -1); noteSpan.className = isTarget ? 'font-bold' : 'text-cyan-300'; noteDisplay.appendChild(noteSpan); } await new Promise(resolve => setTimeout(resolve, noteDurationSec * 1000 + (timeOffset * 1000))); } } finally { isPlaying = false; } }
    
    // --- MAIN SETUP & RENDERING ---
    function setupControls() { document.body.addEventListener('click', initAudio, { once: true }); document.getElementById('tab-lab').addEventListener('click', () => switchTab('lab')); document.getElementById('tab-ear-trainer').addEventListener('click', () => switchTab('ear-trainer')); document.getElementById('practice-mode').addEventListener('change', renderUI); document.getElementById('progression-type').addEventListener('change', renderUI); document.getElementById('tonality-selector').addEventListener('change', (e) => { currentTonality = e.target.value; updateRootNoteSelector(); }); document.getElementById('root-note').addEventListener('change', renderUI); document.getElementById('chord-type').addEventListener('change', updateScaleSelector); document.getElementById('scale-type').addEventListener('change', renderUI); document.getElementById('approach-group').addEventListener('change', renderUI); document.getElementById('synth-sound').addEventListener('change', (e) => { changeSynth(e.target.value) }); document.getElementById('tempo-slider').addEventListener('input', e => { if(isAudioReady) Tone.Transport.bpm.value = e.target.value; document.getElementById('tempo-display').textContent = e.target.value; }); document.getElementById('rhythm-selector').addEventListener('change', e => { if(isAudioReady) Tone.Transport.swing = e.target.value === 'swing' ? 0.6 : 0; }); document.getElementById('metronome-toggle').addEventListener('click', toggleMetronome); document.getElementById('metronome-accent').addEventListener('change', setupMetronome); document.getElementById('metronome-volume').addEventListener('input', e => { if (isAudioReady) { const volumeValue = e.target.value; metroVolumeNode.volume.value = volumeValue; document.getElementById('metro-vol-display').textContent = volumeValue > 0 ? `+${volumeValue}` : volumeValue; } }); document.getElementById('progression-play-btn').addEventListener('click', toggleProgressionPlayback); document.getElementById('ear-trainer-listen-btn').addEventListener('click', startEarTrainerGame); setupHelpFeatures(); }
    function populateStaticDropdowns() { document.getElementById('practice-mode').innerHTML = `<option value="single-chord">Acorde Individual</option><option value="progression">Progresi√≥n ii-V-I</option>`; document.getElementById('progression-type').innerHTML = `<option value="major">Mayor (ii-V-I)</option><option value="minor">Menor (ii√∏-V-i)</option>`; document.getElementById('tonality-selector').innerHTML = `<option value="#">Sostenidos (#)</option><option value="b">Bemoles (b)</option>`; document.getElementById('synth-sound').innerHTML = `<option value="rhodes">Rhodes</option><option value="synth">Synth</option><option value="fmsine">FM Sine</option>`; Object.keys(CHORD_FORMULAS).forEach(key => { document.getElementById('chord-type').innerHTML += `<option value="${key}">${CHORD_FORMULAS[key].name}</option>`; }); Object.keys(APPROACH_DEFINITIONS).forEach(groupName => { document.getElementById('approach-group').innerHTML += `<option value="${groupName}">${groupName}</option>`; }); document.getElementById('chord-type').value = 'maj7'; }
    function switchTab(tab) { document.getElementById('practice-lab-view').style.display = tab === 'lab' ? 'block' : 'none'; document.getElementById('ear-trainer-view').style.display = tab === 'ear-trainer' ? 'block' : 'none'; document.getElementById('tab-lab').classList.toggle('active', tab === 'lab'); document.getElementById('tab-ear-trainer').classList.toggle('active', tab === 'ear-trainer'); }
    function updateRootNoteSelector() { const rootSelect = document.getElementById('root-note'); rootSelect.innerHTML = ''; ROOT_NOTES[currentTonality].forEach(note => { rootSelect.innerHTML += `<option value="${note}">${note}</option>`; }); updateScaleSelector(true); }
    function updateScaleSelector(isChainedCall=false) { const chordKey = document.getElementById('chord-type').value; const availableScales = CHORD_TO_SCALE_MAP[chordKey] || []; const scaleSelect = document.getElementById('scale-type'); scaleSelect.innerHTML = ''; availableScales.forEach(scaleKey => { scaleSelect.innerHTML += `<option value="${scaleKey}">${SCALE_FORMULAS[scaleKey].name}</option>`; }); if(chordKey === '7'){scaleSelect.value = 'mixolydian'}; if(!isChainedCall) renderUI(); else renderUI(); }
    function renderUI() { const mode = document.getElementById('practice-mode').value; const chordControls = document.getElementById('chord-tour'); const scaleControls = document.getElementById('scale-tour'); const progPlayBtn = document.getElementById('progression-play-btn'); const progTypeControl = document.getElementById('progression-type-tour'); if (mode === 'progression') { chordControls.classList.add('hidden'); scaleControls.classList.add('hidden'); progPlayBtn.classList.remove('hidden'); progTypeControl.classList.remove('hidden'); } else { chordControls.classList.remove('hidden'); scaleControls.classList.remove('hidden'); progPlayBtn.classList.add('hidden'); progTypeControl.classList.add('hidden'); } document.getElementById('progression-view-container').style.display = mode === 'progression' ? 'grid' : 'none'; document.querySelector('[for="root-note"]').textContent = mode === 'progression' ? 'T√≥nica (I):' : 'Ra√≠z:'; if (mode === 'progression') { renderProgression(); } renderCombinationSelector(); renderActiveApproachCard(); }
    function renderProgression() { const rootNoteName = document.getElementById('root-note').value; const progType = document.getElementById('progression-type').value; const progressionContainer = document.getElementById('progression-view-container'); progressionContainer.innerHTML = ''; const rootMidi = getMidiFromNoteName(`${rootNoteName}4`); const ii_midi = rootMidi + 2; const V_midi = rootMidi + 7; const I_midi = rootMidi; const ii_note = getNoteWithOctave(ii_midi,[]).slice(0,-1); const V_note = getNoteWithOctave(V_midi,[]).slice(0,-1); const I_note = rootNoteName; let progressionData; if (progType === 'major') { progressionData = [ { label: 'ii', root: ii_note, name: `${ii_note}m7`, chordType: 'm7', scaleType: 'dorian' }, { label: 'V', root: V_note, name: `${V_note}7`, chordType: '7', scaleType: 'mixolydian' }, { label: 'I', root: I_note, name: `${I_note}maj7`, chordType: 'maj7', scaleType: 'ionian' } ]; } else { progressionData = [ { label: 'ii√∏', root: ii_note, name: `${ii_note}m7(b5)`, chordType: 'm7b5', scaleType: 'locrian' }, { label: 'V', root: V_note, name: `${V_note}7alt`, chordType: '7', scaleType: 'altered' }, { label: 'i', root: I_note, name: `${I_note}m7`, chordType: 'm7', scaleType: 'aeolian' } ]; } progressionData.forEach((chord, index) => { const chordEl = document.createElement('div'); chordEl.className = 'progression-chord'; chordEl.dataset.index = index; chordEl.dataset.root = chord.root; chordEl.dataset.chordType = chord.chordType; chordEl.dataset.scaleType = chord.scaleType; chordEl.innerHTML = `<h3 class="font-bold text-lg">${chord.name}</h3><p class="text-sm text-[#94a3b8]">${chord.label}</p>`; chordEl.addEventListener('click', () => { activeProgressionChordIndex = index; progressionContainer.querySelectorAll('.progression-chord').forEach(c => c.classList.remove('active')); chordEl.classList.add('active'); renderActiveApproachCard(); }); progressionContainer.appendChild(chordEl); }); if(progressionContainer.children.length > 0) { progressionContainer.children[activeProgressionChordIndex].classList.add('active'); } }
    function renderCombinationSelector() { const groupKey = document.getElementById('approach-group').value; const combinations = (groupKey === 'Favoritos') ? favorites : APPROACH_DEFINITIONS[groupKey]; const container = document.getElementById('combination-selector-container'); let html = '<div class="flex flex-wrap gap-3 justify-center">'; if (combinations && combinations.length > 0) { combinations.forEach((combo, index) => { const isFavorited = favorites.some(f => f.id === combo.id); html += `<div class="flex items-center gap-2"><span class="favorite-star ${isFavorited ? 'favorited' : ''}" data-id="${combo.id}">‚≠ê</span><input type="radio" name="combination-selector" id="combo-${combo.id}" value="${index}" class="hidden combination-input"><label for="combo-${combo.id}" class="combination-label text-sm">${combo.name}</label></div>`; }); } else { html += '<p class="text-[#94a3b8]">A√∫n no has a√±adido favoritos. ¬°Usa la ‚≠ê!</p>'; } html += '</div>'; container.innerHTML = html; document.querySelectorAll('input[name="combination-selector"]').forEach(radio => radio.addEventListener('change', renderActiveApproachCard)); document.querySelectorAll('.favorite-star').forEach(star => star.addEventListener('click', toggleFavorite)); document.getElementById('play-all-container').innerHTML = `<button id="play-all-btn" class="btn btn-primary">‚ñ∂Ô∏è Tocar Todas</button>`; document.getElementById('play-all-btn').addEventListener('click', playAllCombinations); }
    function renderActiveApproachCard() { const mode = document.getElementById('practice-mode').value; const groupKey = document.getElementById('approach-group').value; let combination; if (mode === 'single-chord' || mode === 'progression') { const combinations = (groupKey === 'Favoritos') ? favorites : APPROACH_DEFINITIONS[groupKey]; const selectedIdx = document.querySelector('input[name="combination-selector"]:checked')?.value || 0; if(combinations && combinations.length > 0) { combination = combinations[selectedIdx]; if(document.querySelector(`#combo-${combinations[selectedIdx].id}`)) { document.querySelector(`#combo-${combinations[selectedIdx].id}`).checked = true; } } } const container = document.getElementById('approach-card-container'); if (!combination) { container.innerHTML = '<p class="text-gray-600">Selecciona un grupo de aproximaciones.</p>'; return; } container.innerHTML = `<div class="card bg-[#1E293B] rounded-xl p-6 flex flex-col gap-4 shadow-2xl w-full max-w-lg"></div>`; const card = container.querySelector('.card'); card.innerHTML = `<div><p class="text-2xl font-bold text-white mb-1">${combination.name}</p></div><div class="target-buttons-container flex flex-wrap gap-2 text-center justify-center"></div><div class="note-display my-2"><span class="text-[#64748b]">Las notas aparecer√°n aqu√≠...</span></div><div class="piano-container mt-4"></div>`; createPiano(card.querySelector('.piano-container')); updateCardTargets(card, combination); }
    function updateCardTargets(card, combination) { let rootNoteName, scaleKey, chordKey; const mode = document.getElementById('practice-mode').value; if (mode === 'progression') { const activeChordEl = document.querySelector('.progression-chord.active'); if (!activeChordEl) return; rootNoteName = activeChordEl.dataset.root; scaleKey = activeChordEl.dataset.scaleType; chordKey = activeChordEl.dataset.chordType; card.dataset.chordType = chordKey; } else { rootNoteName = document.getElementById('root-note').value; scaleKey = document.getElementById('scale-type').value; chordKey = document.getElementById('chord-type').value; card.dataset.chordType = chordKey; } const scaleFormula = SCALE_FORMULAS[scaleKey]; if (!scaleFormula) return; const fullScale = buildScale(rootNoteName, scaleFormula.intervals); let baseScaleForTargets; if (scaleKey === 'altered') { baseScaleForTargets = buildScale(rootNoteName, SCALE_FORMULAS.mixolydian.intervals); } else { baseScaleForTargets = fullScale; } const chordTones = [baseScaleForTargets[0], baseScaleForTargets[2], baseScaleForTargets[4], baseScaleForTargets[6]]; const btnContainer = card.querySelector('.target-buttons-container'); btnContainer.innerHTML = ''; chordTones.forEach((note, i) => { const chordFormula = CHORD_FORMULAS[chordKey]; const majorScaleIntervals = SCALE_FORMULAS.ionian.intervals; const chordInterval = chordFormula.intervals[i]; const majorInterval = majorScaleIntervals[i * 2]; let degreeText = [1, 3, 5, 7][i]; if (chordInterval < majorInterval) degreeText = `‚ô≠${degreeText}`; if (chordInterval > majorInterval && majorInterval !== undefined) degreeText = `#${degreeText}`; const button = document.createElement('button'); button.textContent = `T${degreeText}`; button.className = 'target-button text-xs bg-[#475569] hover:bg-[#FBBF24] hover:text-slate-900 text-white font-semibold py-1 px-3 rounded-full transition-colors'; const extendedScale = [-1,0,1,2,3,4,5].flatMap(oct => buildScale(rootNoteName, scaleFormula.intervals).map(n => `${n.slice(0,-1)}${oct+2}`)); button.onclick = () => { const sequence = getApproachSequence(combination.code, note, extendedScale); playSequence(sequence, note, card, rootNoteName); }; btnContainer.appendChild(button); }); }
    function createPiano(container) { const startMidi = 48; const endMidi = 77; const piano = Array.from({length: endMidi - startMidi + 1}, (_, i) => i + startMidi); const numWhiteKeys = piano.filter(midi => MIDI_TO_SHARP[midi % 12].length === 1).length; let whiteKeyIndex = 0; for (const midi of piano) { const noteSharp = `${MIDI_TO_SHARP[midi % 12]}${Math.floor(midi / 12) - 1}`; const noteFlat = `${MIDI_TO_FLAT[midi % 12]}${Math.floor(midi / 12) - 1}`; const key = document.createElement('div'); key.dataset.note = noteSharp; if (noteSharp !== noteFlat) key.dataset.noteFlat = noteFlat; key.classList.add('piano-key'); if (MIDI_TO_SHARP[midi % 12].length > 1) { key.classList.add('black-key'); key.style.left = `${(whiteKeyIndex - 0.35) * (100 / numWhiteKeys)}%`; } else { key.classList.add('white-key'); key.style.width = `${100 / numWhiteKeys}%`; key.style.left = `${whiteKeyIndex * (100 / numWhiteKeys)}%`; whiteKeyIndex++; } container.appendChild(key); } }
    
    // --- Metronome Logic ---
    function setupMetronome() { if (!isAudioReady) return; const wasPlaying = metronomeSequence && metronomeSequence.state === 'started'; if (metronomeSequence) { metronomeSequence.stop().dispose(); metronomeSequence = null; } const accent = parseInt(document.getElementById('metronome-accent').value); if (accent < 0) { const btn = document.getElementById('metronome-toggle'); btn.classList.remove('active-metronome'); if (progressionLoop.state !== 'started' && wasPlaying) { Tone.Transport.stop(); } return; } let events; if (accent > 0) { events = ['C5', ...Array(accent - 1).fill('C4')]; } else { events = ['C4']; } metronomeSequence = new Tone.Sequence((time, note) => { if (note === 'C5') { metroAccent.triggerAttackRelease("G5", "32n", time); } else { metroClick.triggerAttackRelease("G4", "32n", time); } }, events, "4n"); if (wasPlaying) { metronomeSequence.start(0); } }
    function toggleMetronome() { if (!isAudioReady) return; const btn = document.getElementById('metronome-toggle'); const accentDropdown = document.getElementById('metronome-accent'); if (metronomeSequence && metronomeSequence.state === 'started') { metronomeSequence.stop(); btn.classList.remove('active-metronome'); if (progressionLoop.state !== 'started') { Tone.Transport.stop(); } } else { if (accentDropdown.value < 0) { accentDropdown.value = '4'; } if (!metronomeSequence) { setupMetronome(); } if (metronomeSequence) { Tone.Transport.start(); metronomeSequence.start(0); btn.classList.add('active-metronome'); } } }
    
    // --- Playback Logic ---
    function toggleProgressionPlayback() { if(!isAudioReady) return; const btn = document.getElementById('progression-play-btn'); if (progressionLoop.state === 'started') { progressionLoop.stop(); btn.textContent = '‚ñ∂Ô∏è Play'; btn.classList.remove('btn-stop'); btn.classList.add('btn-primary'); if (!metronomeSequence || metronomeSequence.state !== 'started') { Tone.Transport.stop(); } } else { Tone.Transport.start(); progressionLoop.start(0); btn.textContent = '‚èπÔ∏è Stop'; btn.classList.remove('btn-primary'); btn.classList.add('btn-stop'); } }
    function toggleFavorite(e) { const id = e.target.dataset.id; const allApproaches = Object.values(APPROACH_DEFINITIONS).flat(); const approach = allApproaches.find(a => a.id === id); if (!approach) return; const favIndex = favorites.findIndex(f => f.id === id); if (favIndex > -1) { favorites.splice(favIndex, 1); } else { favorites.push(approach); } localStorage.setItem('jazzLabFavorites', JSON.stringify(favorites)); renderCombinationSelector(); const activeRadio = document.querySelector(`input[id="combo-${id}"]`); if(activeRadio) activeRadio.checked = true; }
    async function playAllCombinations() { const playAllBtn = document.getElementById('play-all-btn'); if (isPlayingAll) { forceStopPlayAll = true; if(synth) synth.releaseAll(); return; } isPlayingAll = true; forceStopPlayAll = false; document.querySelectorAll('button:not(#play-all-btn), select, .combination-input, .favorite-star, .progression-chord, .tab').forEach(el => el.disabled = true); if (playAllBtn) { playAllBtn.textContent = '‚èπÔ∏è Stop'; playAllBtn.classList.remove('btn-primary'); playAllBtn.classList.add('btn-stop'); } let wasProgressionPlaying = false; if (progressionLoop && progressionLoop.state === 'started') { wasProgressionPlaying = true; progressionLoop.stop(); const progBtn = document.getElementById('progression-play-btn'); progBtn.textContent = '‚ñ∂Ô∏è Play'; progBtn.classList.remove('btn-stop'); progBtn.classList.add('btn-primary'); } try { const groupKey = document.getElementById('approach-group').value; const allCombinations = (groupKey === 'Favoritos') ? favorites : APPROACH_DEFINITIONS[groupKey]; if (!allCombinations || allCombinations.length === 0) return; const selectedRadio = document.querySelector('input[name="combination-selector"]:checked'); const startCombinationIndex = selectedRadio ? parseInt(selectedRadio.value, 10) : 0; const mode = document.getElementById('practice-mode').value; let chordElements = [null]; let startChordIndex = 0; if (mode === 'progression') { chordElements = Array.from(document.querySelectorAll('.progression-chord')); startChordIndex = activeProgressionChordIndex; } for (let i = startChordIndex; i < chordElements.length; i++) { if (forceStopPlayAll) break; if (mode === 'progression') { activeProgressionChordIndex = i; document.querySelectorAll('.progression-chord').forEach((c, c_idx) => c.classList.toggle('active', c_idx === i)); } const currentCombinationIndex = (i === startChordIndex) ? startCombinationIndex : 0; const combinationsToPlay = allCombinations.slice(currentCombinationIndex); for (const combination of combinationsToPlay) { if (forceStopPlayAll) break; const radioToSelect = document.getElementById(`combo-${combination.id}`); if (radioToSelect) { radioToSelect.checked = true; const label = radioToSelect.nextElementSibling; document.querySelectorAll('.combination-label').forEach(l => l.classList.remove('highlight')); if(label) label.classList.add('highlight'); renderActiveApproachCard(); await new Promise(res => setTimeout(res, 50)); if (forceStopPlayAll) break; const targetButtons = document.querySelectorAll('#approach-card-container .target-button'); for (let btnIndex = 0; btnIndex < targetButtons.length; btnIndex++) { const button = targetButtons[btnIndex]; if (forceStopPlayAll) break; button.classList.add('highlight-target'); button.click(); await new Promise(resolve => { const checkPlaying = setInterval(() => { if (!isPlaying || forceStopPlayAll) { clearInterval(checkPlaying); resolve(); } }, 50); }); button.classList.remove('highlight-target'); if (forceStopPlayAll) break; await new Promise(resolve => setTimeout(resolve, 750)); } } } } } finally { isPlayingAll = false; forceStopPlayAll = false; document.querySelectorAll('button, select, .combination-input, .favorite-star, .progression-chord, .tab').forEach(el => el.disabled = false); if (playAllBtn) { playAllBtn.textContent = '‚ñ∂Ô∏è Tocar Todas'; playAllBtn.classList.remove('btn-stop'); playAllBtn.classList.add('btn-primary'); } document.querySelectorAll('.combination-label').forEach(l => l.classList.remove('highlight')); document.querySelectorAll('.target-button.highlight-target').forEach(b => b.classList.remove('highlight-target')); if (wasProgressionPlaying) { } } }
    
    // --- Ear Trainer ---
    function startEarTrainerGame() { document.getElementById('ear-trainer-listen-btn').disabled = true; const allApproaches = Object.values(APPROACH_DEFINITIONS).filter(g => Array.isArray(g) && g.length > 0).flat(); const correctAnswer = allApproaches[Math.floor(Math.random() * allApproaches.length)]; const wrongAnswers = []; while(wrongAnswers.length < 3) { const randomWrong = allApproaches[Math.floor(Math.random() * allApproaches.length)]; if(randomWrong.id !== correctAnswer.id && !wrongAnswers.some(a => a.id === randomWrong.id)) { wrongAnswers.push(randomWrong); } } const options = [correctAnswer, ...wrongAnswers].sort(() => Math.random() - 0.5); earTrainerState = { correctAnswer, options }; const root = 'C'; const scale = buildScale(root, SCALE_FORMULAS.ionian.intervals); const extendedScale = [3,4,5].flatMap(oct => scale.map(n => `${n.slice(0,-1)}${oct}`)); const target = 'E4'; const sequence = getApproachSequence(correctAnswer.code, target, extendedScale); const card = document.createElement('div'); card.dataset.chordType = 'maj7'; playSequence(sequence, target, card, root); const optionsContainer = document.getElementById('ear-trainer-options'); optionsContainer.innerHTML = ''; options.forEach(opt => { const button = document.createElement('button'); button.className = 'btn btn-secondary'; button.textContent = opt.name; button.onclick = () => checkEarTrainerAnswer(opt.id, button); optionsContainer.appendChild(button); }); document.getElementById('ear-trainer-feedback').textContent = ''; setTimeout(() => { document.getElementById('ear-trainer-listen-btn').disabled = false; }, 2000); }
    function checkEarTrainerAnswer(selectedId, button) { const scoreEl = document.getElementById('ear-trainer-score'); const attemptsEl = document.getElementById('ear-trainer-attempts'); const feedbackEl = document.getElementById('ear-trainer-feedback'); attemptsEl.textContent = parseInt(attemptsEl.textContent) + 1; document.querySelectorAll('#ear-trainer-options button').forEach(btn => btn.disabled = true); if (selectedId === earTrainerState.correctAnswer.id) { scoreEl.textContent = parseInt(scoreEl.textContent) + 1; feedbackEl.textContent = '¬°Correcto!'; feedbackEl.className = 'mt-6 h-6 font-semibold text-green-400'; button.classList.replace('btn-secondary', 'btn-primary'); setTimeout(startEarTrainerGame, 1500); } else { feedbackEl.textContent = `Incorrecto. La respuesta era: ${earTrainerState.correctAnswer.name}`; feedbackEl.className = 'mt-6 h-6 font-semibold text-red-400'; button.classList.replace('btn-secondary', 'btn-stop'); document.getElementById('ear-trainer-listen-btn').textContent = "üéµ Escuchar de Nuevo y Seguir"; document.querySelectorAll('#ear-trainer-options button').forEach(btn => btn.disabled = false); } }
    
    // --- HELP FEATURES: GLOSSARY & INTERACTIVE TOUR ---
    function setupHelpFeatures() { const glossaryModal = document.getElementById('glossary-modal'); const glossaryBtn = document.getElementById('glossary-btn'); glossaryBtn.addEventListener('click', () => { glossaryModal.querySelector('.prose').innerHTML = `<button class="modal-close-btn">&times;</button>` + getGlossaryContent(); glossaryModal.classList.add('active'); glossaryModal.querySelectorAll('.interactive-sigla').forEach(sigla => { sigla.addEventListener('click', () => playGlossaryExample(sigla.dataset.sigla)); }); glossaryModal.querySelector('.modal-close-btn').addEventListener('click', () => glossaryModal.classList.remove('active')); }); glossaryModal.addEventListener('click', e => { if(e.target === glossaryModal) glossaryModal.classList.remove('active'); }); document.getElementById('tutorial-btn').addEventListener('click', startTour); }
    function getGlossaryContent() { const soundIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-1.414 1.414A6.476 6.476 0 0 1 12.025 8a6.476 6.476 0 0 1-1.904 4.596l1.414 1.414zM10.121 12.596A6.475 6.475 0 0 0 12.025 8a6.475 6.475 0 0 0-1.904-4.596L8.707 4.828A4.478 4.478 0 0 1 10.025 8a4.478 4.478 0 0 1-1.318 3.172l1.414 1.414zM8.5 10.188a2.5 2.5 0 0 0 0-4.376l-1.06-.825A3.5 3.5 0 0 1 8.5 8a3.5 3.5 0 0 1-1.06 2.488l1.06-.824zM6.25 4.633a1.5 1.5 0 0 1 0 2.734L5.19 8.19A2.5 2.5 0 0 0 4 8a2.5 2.5 0 0 0-1.19.367l1.06.824a1.5 1.5 0 0 1 0-2.734L4 5.467zM2.729 6.65A1.5 1.5 0 0 0 2 8a1.5 1.5 0 0 0 .729 1.35l-1.06.824A2.5 2.5 0 0 1 0 8a2.5 2.5 0 0 1 1.669-2.488l1.06.825z"/></svg>`; return `<h1>Glosario Interactivo</h1><p>Haz clic en una sigla para escuchar un ejemplo de audio.</p><h2>Conceptos Fundamentales</h2><ul><li><strong>Nota Objetivo (Target Note):</strong> Es la nota a la que queremos llegar. En esta herramienta, son las notas del acorde (<code>T1</code>, <code>T3</code>, <code>T5</code>, <code>T7</code>).</li><li><strong>Notas de Aproximaci√≥n:</strong> Notas que se tocan justo <em>antes</em> de la nota objetivo para crear tensi√≥n y resoluci√≥n.</li><li><strong>Encierro (Enclosure):</strong> T√©cnica donde la nota objetivo es "encerrada" por notas superiores e inferiores.</li></ul><h2>Siglas de Movimiento</h2><ul><li><button class="interactive-sigla" data-sigla="SA">${soundIcon} SA</button>: <strong>Scale Above</strong> (Nota de Escala Arriba).</li><li><button class="interactive-sigla" data-sigla="SB">${soundIcon} SB</button>: <strong>Scale Below</strong> (Nota de Escala Abajo).</li><li><button class="interactive-sigla" data-sigla="CA">${soundIcon} CA</button>: <strong>Chromatic Above</strong> (Nota Crom√°tica Arriba, un semitono).</li><li><button class="interactive-sigla" data-sigla="CB">${soundIcon} CB</button>: <strong>Chromatic Below</strong> (Nota Crom√°tica Abajo, un semitono).</li><li><button class="interactive-sigla" data-sigla="DCA">${soundIcon} DCA</button>: <strong>Double Chromatic Above</strong> (Doble Crom√°tica Arriba).</li><li><button class="interactive-sigla" data-sigla="DCB">${soundIcon} DCB</button>: <strong>Double Chromatic Below</strong> (Doble Crom√°tica Abajo).</li><li><button class="interactive-sigla" data-sigla="WA">${soundIcon} WA</button>: <strong>Whole Step Above</strong> (Tono Entero Arriba).</li><li><button class="interactive-sigla" data-sigla="WB">${soundIcon} WB</button>: <strong>Whole Step Below</strong> (Tono Entero Abajo).</li></ul><h2>S√≠mbolos en "Estructura Constante"</h2><ul><li><strong>T+</strong>: Tono Arriba (equivale a WA).</li><li><strong>T-</strong>: Tono Abajo (equivale a WB).</li><li><strong>C+</strong>: Crom√°tico Arriba (equivale a CA).</li><li><strong>C-</strong>: Crom√°tico Abajo (equivale a CB).</li></ul>`; }
    async function playGlossaryExample(sigla) { if (!isAudioReady || isPlaying) return; const targetNote = 'C4'; const scale = buildScale('C', SCALE_FORMULAS.ionian.intervals); const sequence = getApproachSequence([sigla], targetNote, scale.concat(['C5', 'B3'])); isPlaying = true; for(const note of sequence) { synth.triggerAttackRelease(note, '8n', Tone.now()); await new Promise(res => setTimeout(res, 200)); } await new Promise(res => setTimeout(res, 100)); synth.triggerAttackRelease(targetNote, '4n', Tone.now()); await new Promise(res => setTimeout(res, 400)); isPlaying = false; }
    const tourSteps = [ { selector: '#mode-tour', content: '<h3>1. Modo de Pr√°ctica</h3><p>Elige si quieres practicar sobre un <strong>Acorde Individual</strong> o una <strong>Progresi√≥n ii-V-I</strong> completa.</p>' }, { selector: '#progression-type-tour', content: '<h3>2. Tipo de Progresi√≥n</h3><p>Si eliges "Progresi√≥n", decide si quieres practicar la secuencia que resuelve en un acorde <strong>Mayor</strong> o <strong>Menor</strong>. Esto cambiar√° la calidad de los acordes.</p>'}, { selector: '#root-tour', content: '<h3>3. Tonalidad y Ra√≠z</h3><p>Establece el contexto arm√≥nico. Selecciona la tonalidad y la nota ra√≠z del acorde (o la t√≥nica del Imaj7 en una progresi√≥n).</p>' }, { selector: '#chord-tour', content: '<h3>4. Tipo de Acorde y Escala</h3><p>En modo "Acorde Individual", define el sonido exacto que quieres estudiar. La herramienta te sugerir√° las escalas m√°s comunes.</p>' }, { selector: '#metronome-controls-tour', content: '<h3>5. Controles de Ritmo</h3><p>Ajusta el <strong>Tempo</strong> y el <strong>Ritmo</strong>. Adem√°s, puedes activar el <strong>Metr√≥nomo</strong>, ajustar su <strong>Volumen</strong> y definir un <strong>Acento</strong> r√≠tmico para marcar el comp√°s.</p>'}, { selector: '#approach-group-tour', content: '<h3>6. Grupo de Aproximaciones</h3><p>Selecciona el tipo de "adorno" mel√≥dico que quieres practicar, clasificado por el n√∫mero de notas que contiene.</p>' }, { selector: '#combination-selector-container', content: '<h3>7. Elige la Combinaci√≥n</h3><p>Aqu√≠ aparecen todas las variaciones del grupo que elegiste. Haz clic en una para cargarla en la tarjeta de pr√°ctica.</p>' }, { selector: '#approach-card-container', content: '<h3>8. Toca las Notas Objetivo</h3><p>Estos son los "targets" (T1, T3, T5, T7). Haz clic en uno para escuchar la combinaci√≥n resolviendo en esa nota del acorde.</p>' }, { selector: '#play-all-container', content: '<h3>9. ¬°Automatiza tu Pr√°ctica!</h3><p>Usa "Tocar Todas" para escuchar todas las combinaciones del grupo aplicadas a todos los targets. Es la mejor forma de interiorizar los sonidos.</p>' } ]; let currentStep = 0; const tourOverlay = document.getElementById('tour-overlay'); const tourPopover = document.getElementById('tour-popover');
    function startTour() { const mode = document.getElementById('practice-mode').value; const dynamicTourSteps = tourSteps.filter(step => { if (step.selector === '#progression-type-tour') return mode === 'progression'; if (step.selector === '#chord-tour' || step.selector === '#scale-tour') return mode === 'single-chord'; return true; }); const numberedSteps = dynamicTourSteps.map((step, index) => { const newContent = step.content.replace(/<h3>\d+\./, `<h3>${index + 1}.`); return { ...step, content: newContent }; }); currentStep = 0; tourOverlay.style.display = 'block'; tourPopover.style.display = 'block'; document.querySelectorAll('.tour-highlight').forEach(el => el.classList.remove('tour-highlight')); showTourStep(currentStep, numberedSteps); }
    function endTour() { tourOverlay.style.display = 'none'; tourPopover.style.display = 'none'; const highlightedEl = document.querySelector('.tour-highlight'); if (highlightedEl) highlightedEl.classList.remove('tour-highlight'); }
    function showTourStep(index, steps) { document.querySelectorAll('.tour-highlight').forEach(el => el.classList.remove('tour-highlight')); const step = steps[index]; const targetElement = document.querySelector(step.selector); if (!targetElement || targetElement.offsetParent === null) { endTour(); return; } targetElement.classList.add('tour-highlight'); targetElement.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' }); const popoverContent = document.getElementById('tour-content'); popoverContent.innerHTML = step.content; const rect = targetElement.getBoundingClientRect(); const popover = document.getElementById('tour-popover'); let popoverTop = rect.bottom + 15; if (popoverTop + popover.offsetHeight + 10 > window.innerHeight) { popoverTop = rect.top - popover.offsetHeight - 15; } let popoverLeft = rect.left + rect.width / 2 - popover.offsetWidth / 2; popover.style.top = `${popoverTop}px`; popover.style.left = `${Math.max(10, Math.min(popoverLeft, window.innerWidth - popover.offsetWidth - 10))}px`; document.getElementById('tour-step-indicator').textContent = `${index + 1} / ${steps.length}`; const prevBtn = document.getElementById('tour-prev'); const nextBtn = document.getElementById('tour-next'); prevBtn.disabled = index === 0; nextBtn.textContent = index === steps.length - 1 ? 'Finalizar' : 'Siguiente'; prevBtn.onclick = () => { if (index > 0) showTourStep(index - 1, steps); }; nextBtn.onclick = () => { if (index < steps.length - 1) showTourStep(index + 1, steps); else endTour(); }; }
    document.getElementById('tour-close').addEventListener('click', endTour);

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        const savedFavorites = localStorage.getItem('jazzLabFavorites');
        if(savedFavorites) {
            favorites = JSON.parse(savedFavorites);
        }
        populateStaticDropdowns();
        setupControls();
        updateRootNoteSelector();
    });
</script>

</body>
</html>


