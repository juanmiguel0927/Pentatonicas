<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laboratorio de Pentatónicas y Arpegios</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        /* General Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #d1d5db;
        }
        .container {
            max-width: 1500px;
            margin: 0 auto;
            padding: 1rem;
        }
        .tabs button {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 500;
            color: #9ca3af;
            background-color: #1f2937;
            border: 1px solid transparent;
            transition: all 0.3s ease;
        }
        .tabs button.active {
            background-color: #3b82f6;
            color: #fff;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        .tabs button:hover:not(.active) {
            background-color: #374151;
            color: #e5e7eb;
        }
        .tab-content {
            background-color: #1f2937;
            padding: 1.25rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            margin-top: 1.5rem;
        }
        h1, h2, h3 { color: #fff; }
        .input-group {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.25rem;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }
        .input-group label {
            font-weight: 500;
            color: #fff;
        }
        .input-group select, .input-group input[type="number"], .input-group input[type="range"], .input-group input[type="checkbox"] {
            background-color: #374151;
            border-radius: 8px;
            padding: 0.5rem;
            border: 1px solid #4b5563;
            color: #fff;
        }
         .input-group input[type="checkbox"] {
            height: 1.25rem;
            width: 1.25rem;
            padding: 0;
         }
        .action-button {
            background-color: #3b82f6;
            color: #fff;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: bold;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        .action-button:hover {
            background-color: #2563eb;
            box-shadow: 0 2px 10px rgba(59, 130, 246, 0.4);
        }
        .action-button.stop-btn { background-color: #ef4444; }
        .action-button.stop-btn:hover { background-color: #dc2626; }

        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        th, td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid #374151;
            vertical-align: top;
            font-size: 0.9rem;
        }
        th {
            background-color: #374151;
            font-weight: 600;
        }
        tr.selected-row {
            background-color: #3b82f6;
        }
        tr.selected-row, tr.selected-row .text-gray-400 {
            color: #ffffff;
        }
        tr:last-child td { border-bottom: none; }
        .example-box {
            background-color: #374151;
            padding: 0.5rem;
            border-radius: 8px;
            margin-top: 0.5rem;
            font-family: monospace;
            font-size: 0.75rem;
            color: #fff;
            white-space: pre;
            overflow-x: auto;
        }

         /* Progression Tab Styles */
        .progression-card {
            background-color: #374151;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            height: 100%;
        }
        .chord-box {
            background-color: #4b5563;
            padding: 0.75rem;
            border-radius: 6px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
        }
        .progression-table {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .prog-type-selector button { background-color: #374151; }
        .prog-type-selector button.active { background-color: #3b82f6; }
        .scale-suggestions li.selected-scale {
            background-color: #3b82f6;
        }
        .scale-suggestions li.selected-scale, .scale-suggestions li.selected-scale span {
            color: #ffffff !important;
        }


        /* Fretboard Visualizer Styles */
        .visualizer-container {
            background-color: #111827;
            padding: 1rem 0;
            border-radius: 8px;
            margin-top: 1.5rem;
            width: 100%;
            overflow-x: auto;
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
            text-align: center; /* Center the inline-block fretboard area */
        }
        .visualizer-container::-webkit-scrollbar {
             display: none; /* Chrome, Safari, Opera */
        }
        .fretboard-area {
            display: inline-flex; /* Changed to inline-flex */
            flex-direction: column;
            align-items: flex-start;
            padding: 0 1rem;
        }
        .fretboard-content {
            display: flex;
            align-items: center;
        }
        .open-strings {
            display: flex;
            flex-direction: column;
            margin-right: 8px;
            font-weight: bold;
            font-size: 0.9rem;
        }
        .open-string-name {
            height: 26px; 
            display: flex;
            align-items: center;
            color: #6b7280;
            transition: color 0.3s ease;
            cursor: pointer;
        }
        .open-string-name.in-scale { color: #e5e7eb; }
        .open-string-name.root { color: #ef4444; }

        .fretboard-wrapper {
            position: relative;
            padding: 5px 0;
            display: inline-block;
        }
        .fretboard {
            background-color: #6b3e24;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            border: 1px solid #4a2c1a;
        }
        .string {
            display: flex;
            align-items: center;
            height: 25px;
        }
        .string:not(:last-child) { border-bottom: 1px solid #4a2c1a; }
        .fret {
            width: 50px; /* Increased width */
            height: 100%;
            border-right: 1px solid #a0a0a0;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            cursor: pointer;
        }
        .fret.nut {
            border-right: 4px solid #2d1a0e;
            width: 10px;
        }
        .note-fixed {
            color: #4a2c1a;
            font-size: 0.7rem;
            font-weight: bold;
            transition: all 0.2s ease-in-out;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            pointer-events: none; /* So the click goes to the parent fret */
        }
        .note-fixed.in-scale {
            background-color: #3b82f6;
            color: white;
            transform: scale(1.1);
        }
        .note-fixed.root { background-color: #ef4444; }
        .note-fixed.playing {
            box-shadow: 0 0 15px 5px #fef08a; /* Yellow glow */
            transform: scale(1.2);
        }
        .open-string-name.playing {
            text-shadow: 0 0 10px #fef08a;
        }
        .inlay-container {
            position: absolute;
            top: 0;
            left: 10px;
            width: calc(100% - 10px);
            height: 100%;
            display: flex;
            pointer-events: none;
        }
        .inlay-fret {
            width: 50px; /* Increased width */
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        .inlay-dot {
            width: 6px;
            height: 6px;
            background-color: #d1c1a9;
            border-radius: 50%;
            position: absolute;
        }
        .inlay-dot.double {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            height: 100%; 
            background-color: transparent;
        }
        .inlay-dot.double::before, .inlay-dot.double::after {
            content: '';
            width: 6px;
            height: 6px;
            background-color: #d1c1a9;
            border-radius: 50%;
        }
        .fret-numbers {
            display: flex;
            margin-left: 18px; /* open-strings width + nut width */
            padding-top: 4px;
        }
        .fret-number {
            width: 50px; /* Increased width */
            flex-shrink: 0;
            text-align: center;
            font-size: 0.75rem;
            color: #9ca3af;
        }
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #4b5563;
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        input[type="range"]:hover {
            opacity: 1;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
        }

        /* Note Span Highlighting */
        .note-span {
            transition: all 0.1s ease-in-out;
            display: inline-block;
        }
        .note-span.playing {
            color: #fef08a;
            text-shadow: 0 0 8px #fef08a;
            transform: scale(1.1);
        }

    </style>
</head>
<body class="bg-gray-900 text-gray-200">
    <div class="container">
        <h1 class="text-4xl font-bold text-center my-8">Laboratorio de Pentatónicas</h1>
        <p class="text-center text-lg mb-4 text-gray-400">
            Conceptos de improvisación con pentatónicas.
        </p>
        <p class="text-center text-sm mb-8 text-gray-500">
            Por: Juan Miguel Rios Redondo
        </p>
         <div class="flex flex-wrap gap-4 justify-center tabs" id="tabs-container">
            <button class="tab-button active" data-tab="simple">Pentatónicas y Arpegios</button>
            <button class="tab-button" data-tab="progression">Progresiones ii-V-I</button>
        </div>
        
        <!-- Tab 1: Pentatonics & Arpeggios -->
        <div class="tab-content" id="tab-simple">
            <h2 class="text-2xl font-semibold mb-4 text-center">Explorador de Pentatónicas y Arpegios Derivados</h2>
            <div class="input-group">
                <label for="root-note">Tonalidad del Acorde:</label>
                <select id="root-note"></select>
                <label for="chord-type">Tipo de Acorde:</label>
                <select id="chord-type"></select>
                <button id="enharmonic-btn" class="action-button">Enarmónico</button>
            </div>
            <div id="simple-mode-content">
                <table class="bg-gray-800 rounded-lg overflow-hidden">
                    <thead>
                        <tr>
                            <th class="rounded-tl-lg">Pentatónica a usar</th>
                            <th>Tríadas Derivadas</th>
                            <th>Tétradas Derivadas</th>
                            <th>Grados sobre el Acorde</th>
                            <th class="rounded-tr-lg">Lógica y Sonido</th>
                        </tr>
                    </thead>
                    <tbody id="scale-table-body">
                    </tbody>
                </table>
                
                <div class="mt-8 p-4 bg-gray-800 rounded-lg">
                    <h3 class="text-xl font-semibold mb-2 text-center">Laboratorio de Melodías y Arpegios</h3>
                     <div class="input-group">
                        <label for="bpm-slider" class="font-semibold">Metrónomo:</label>
                        <input type="range" id="bpm-slider" min="40" max="300" value="120" class="flex-grow">
                        <span id="bpm-value" class="font-bold w-12 text-center bg-gray-700 rounded-md py-1">120 BPM</span>
                    </div>
                    <div class="input-group">
                        <select id="arpeggio-type-select">
                            <option value="triads">Tríadas</option>
                            <option value="tetrads">Tétradas</option>
                        </select>
                        <select id="arpeggio-select" class="flex-grow"></select>
                        <button id="add-arpeggio-btn" class="action-button">Agregar/Actualizar Arpegio</button>
                        <div class="flex items-center">
                            <input type="checkbox" id="arpeggio-random-order">
                            <label for="arpeggio-random-order" class="ml-2">Orden Aleatorio</label>
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="rhythm-select" class="font-semibold">Ritmo:</label>
                        <select id="rhythm-select">
                            <option value="4n">Negra</option>
                            <option value="8n" selected>Corchea</option>
                            <option value="16n">Semicorchea</option>
                        </select>
                        <label for="random-note-count" class="ml-4">Notas Aleatorias (1-5):</label>
                        <input type="number" id="random-note-count" min="1" max="5" value="3" class="w-20 text-center">
                        <button id="add-random-btn" class="action-button bg-yellow-600 hover:bg-yellow-500">Generar Aleatorio</button>
                    </div>
                    <div id="generator-output" class="text-center font-mono text-lg p-4 bg-gray-900 rounded-lg min-h-[3rem] flex items-center justify-center mb-4">
                        <!-- Melody will appear here -->
                    </div>
                    <div class="input-group">
                        <button id="play-melody-btn" class="action-button">Play Melodía</button>
                        <button id="play-arpeggios-btn" class="action-button bg-green-600 hover:bg-green-500">Play Arpegios</button>
                        <button id="stop-melody-btn" class="action-button stop-btn">Stop</button>
                        <button id="clear-melody-btn" class="action-button bg-gray-600 hover:bg-gray-500">Limpiar</button>
                    </div>
                </div>

                <div class="visualizer-container" id="fretboard-container-simple">
                </div>
            </div>
        </div>

        <!-- Tab 2: Progressions -->
        <div class="tab-content hidden" id="tab-progression">
            <h2 class="text-2xl font-semibold mb-4 text-center">Generador de Progresiones ii-V-I</h2>
            
            <div class="input-group">
                <label for="progression-key">Tonalidad (del 'I'):</label>
                <select id="progression-key"></select>
                 <button id="enharmonic-btn-prog" class="action-button">Enarmónico</button>
                <div class="flex gap-2 p-1 bg-gray-700 rounded-full prog-type-selector">
                    <button class="action-button active" data-prog-type="major">Mayor</button>
                    <button class="action-button" data-prog-type="minor">Menor</button>
                </div>
            </div>
            
            <div id="progression-container" class="progression-table"></div>
            
             <div class="mt-8 p-4 bg-gray-800 rounded-lg">
                     <div class="input-group">
                        <label for="bpm-slider-prog" class="font-semibold">Metrónomo:</label>
                        <input type="range" id="bpm-slider-prog" min="40" max="300" value="120" class="flex-grow">
                        <span id="bpm-value-prog" class="font-bold w-12 text-center bg-gray-700 rounded-md py-1">120 BPM</span>
                    </div>
                    <div class="input-group">
                        <p class="text-sm text-gray-400">Selecciona una escala de la progresión para activar los arpegios.</p>
                    </div>
                    <div class="input-group">
                        <select id="arpeggio-type-select-prog">
                            <option value="triads">Tríadas</option>
                            <option value="tetrads">Tétradas</option>
                        </select>
                        <select id="arpeggio-select-prog" class="flex-grow" disabled></select>
                        <button id="add-arpeggio-btn-prog" class="action-button">Agregar/Actualizar Arpegio</button>
                        <div class="flex items-center">
                            <input type="checkbox" id="arpeggio-random-order-prog">
                            <label for="arpeggio-random-order-prog" class="ml-2">Orden Aleatorio</label>
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="rhythm-select-prog" class="font-semibold">Ritmo:</label>
                        <select id="rhythm-select-prog">
                            <option value="4n">Negra</option>
                            <option value="8n" selected>Corchea</option>
                            <option value="16n">Semicorchea</option>
                        </select>
                        <label for="random-note-count-prog" class="ml-4">Notas Aleatorias (1-5):</label>
                        <input type="number" id="random-note-count-prog" min="1" max="5" value="3" class="w-20 text-center">
                        <button id="add-random-btn-prog" class="action-button bg-yellow-600 hover:bg-yellow-500">Generar Aleatorio</button>
                    </div>
                    <div id="generator-output-prog" class="text-center font-mono text-lg p-4 bg-gray-900 rounded-lg min-h-[3rem] flex items-center justify-center mb-4">
                        <!-- Melody will appear here -->
                    </div>
                    <div class="input-group">
                        <button id="play-melody-btn-prog" class="action-button">Play Melodía</button>
                        <button id="stop-melody-btn-prog" class="action-button stop-btn">Stop</button>
                        <button id="clear-melody-btn-prog" class="action-button bg-gray-600 hover:bg-gray-500">Limpiar</button>
                    </div>
                </div>


            <div class="visualizer-container" id="fretboard-container-progression">
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATA AND CONFIGURATIONS ---
        const FLAT_NOTES = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
        const SHARP_NOTES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        
        const ENHARMONIC_MAP = {
            'C#': 'Db', 'Db': 'C#', 'D#': 'Eb', 'Eb': 'D#', 'F#': 'Gb', 'Gb': 'F#',
            'G#': 'Ab', 'Ab': 'G#', 'A#': 'Bb', 'Bb': 'A#', 'B#': 'C', 'Cb': 'B',
            'E#': 'F', 'Fb': 'E', 'Bbb': 'A'
        };

        const KEY_SIGNATURES = {
            'C':  { type: 'sharp' }, 'G':  { type: 'sharp' },
            'D':  { type: 'sharp' }, 'A':  { type: 'sharp' },
            'E':  { type: 'sharp' }, 'B':  { type: 'sharp' },
            'F#': { type: 'sharp' }, 'C#': { type: 'sharp' },
            'F':  { type: 'flat'  }, 'Bb': { type: 'flat'  },
            'Eb': { type: 'flat'  }, 'Ab': { type: 'flat'  },
            'Db': { type: 'flat'  }, 'Gb': { type: 'flat'  },
            'Cb': { type: 'flat'  }
        };
        
        const noteNameToIndex = (name) => {
            const flatIndex = FLAT_NOTES.indexOf(name);
            return (flatIndex !== -1) ? flatIndex : SHARP_NOTES.indexOf(name);
        };
        
        const getPreferredNotes = (note, chordType = '') => {
            const keySig = KEY_SIGNATURES[note];
            if (keySig) return keySig.type === 'flat' ? FLAT_NOTES : SHARP_NOTES;
            if (chordType.includes('m') || chordType.includes('alt') || note.includes('b')) return FLAT_NOTES;
            return SHARP_NOTES;
        };

        const getNoteFromInterval = (rootNote, interval, preferredNotes) => {
            const rootIndex = noteNameToIndex(rootNote);
            const finalIndex = (rootIndex + interval) % 12;
            return preferredNotes[finalIndex];
        };
        
        const getIntervalName = (rootNote, targetNote, chordType) => {
            const rootIndex = noteNameToIndex(rootNote);
            const targetIndex = noteNameToIndex(targetNote);
            const interval = (targetIndex - rootIndex + 12) % 12;
            
            switch (interval) {
                case 0: return 'R'; case 1: return 'b9'; case 2: return '9';
                case 3: return chordType.includes('m') ? 'b3' : '#9';
                case 4: return '3'; case 5: return '11';
                case 6: return chordType.includes('maj7') || chordType.includes('dom') || chordType.includes('alt') ? '#11' : 'b5';
                case 7: return '5'; 
                case 8: return chordType.includes('m') ? 'b6' : '#5';
                case 9: return chordType.includes('m') ? '6' : 'b13';
                case 10: return 'b7'; case 11: return '7'; default: return '?';
            }
        };

        const assignOctaves = (notes) => {
            if (!notes || notes.length === 0) return [];
            let currentOctave = 4;
            let lastNoteIndex = -1;
            const notesWithOctaves = [];

            notes.forEach(note => {
                if(note === null) {
                    notesWithOctaves.push(null);
                    return;
                }

                const currentNoteIndex = noteNameToIndex(note);
                if (lastNoteIndex !== -1 && currentNoteIndex < lastNoteIndex) {
                    if (currentOctave < 5) {
                        currentOctave++;
                    }
                }
                notesWithOctaves.push(note + currentOctave);
                lastNoteIndex = currentNoteIndex;
            });

            return notesWithOctaves;
        };
        
        const pentatonicFormulas = {
            'minor': [0, 3, 5, 7, 10], 'dom7': [0, 2, 4, 7, 10],
            'm7b5': [0, 3, 5, 6, 10], 'majb6': [0, 2, 4, 7, 8]
        };

        const PENTATONIC_DISPLAY_NAMES = {
            'minor': 'minor',
            'dom7': 'dom7',
            'm7b5': 'm7(b5)',
            'majb6': 'maj(b6)'
        };
        
        const chordTypes = {
            'maj7': 'Mayor (Maj7)', 'm7': 'Menor (m7)', 'dom7': 'Dominante (V7)',
            'm7b5': 'Menor 7b5 (ø)', 'alt': 'Dominante Alterado (V7alt)'
        };
       const pentatonicToChordRelations = {
            'maj7': [
                { name: 'Menor del 3er grado', pentatonicRoot: (r) => (r + 4) % 12, type: 'minor', logic: 'Sonido Jónico. Aporta las tensiones 9 y 13 (6).' },
                { name: 'Menor del 7mo grado', pentatonicRoot: (r) => (r + 11) % 12, type: 'minor', logic: 'Sonido Lidio, añade la tensión característica #11.' },
                { name: 'Major b6 del 3er grado', pentatonicRoot: (r) => (r + 4) % 12, type: 'majb6', logic: 'Sonido Lidio Aumentado (Maj7#5), con #11 y #5.' },
                { name: 'm7b5 del #4', pentatonicRoot: (r) => (r + 6) % 12, type: 'm7b5', logic: 'Sonido Lidio con tensiones #11 y 13.' }
            ],
            'm7': [
                { name: 'Menor de la raíz', pentatonicRoot: (r) => r, type: 'minor', logic: 'Sonido Eólico/Dórico base. Aporta la tensión 11.' },
                { name: 'Menor del 5to grado', pentatonicRoot: (r) => (r + 7) % 12, type: 'minor', logic: 'Sonido Dórico. Aporta las tensiones 9 y 13 (6).' },
                { name: 'Menor del 2do grado', pentatonicRoot: (r) => (r + 2) % 12, type: 'minor', logic: 'Sonido Frigio, con la b9 característica.'},
                { name: 'Menor del 4to grado', pentatonicRoot: (r) => (r + 5) % 12, type: 'minor', logic: 'Sonido Eólico, con la 6ta menor (b13) característica.'},
                { name: 'Dominante del b7', pentatonicRoot: (r) => (r + 10) % 12, type: 'dom7', logic: 'Sonido Eólico. Aporta las tensiones 9, 11 y b13 (b6).'}
            ],
            'dom7': [
                { name: 'Menor del 5to grado', pentatonicRoot: (r) => (r + 7) % 12, type: 'minor', logic: 'Sonido Mixolidio (contiene la b7). Aporta 9 y 13.' },
                { name: 'Dominante de la raíz', pentatonicRoot: (r) => r, type: 'dom7', logic: 'Pentatónica Mixolidia básica. Aporta la tensión 9.' },
                { name: 'Menor del 6to grado', pentatonicRoot: (r) => (r + 9) % 12, type: 'minor', logic: 'Sonido Mixolidio b13, con un color bluesy.'},
                { name: 'm7b5 del 3er grado', pentatonicRoot: (r) => (r + 4) % 12, type: 'm7b5', logic: 'Sonido Alterado. Aporta las tensiones b9 y #9.'},
                { name: 'Majb6 del 2do grado', pentatonicRoot: (r) => (r + 2) % 12, type: 'majb6', logic: 'Sonido Mixolidio #11 (Lidio b7), con la #11 característica.'},
                { name: 'Menor de la Raíz', pentatonicRoot: (r) => r, type: 'minor', logic: 'Sonido Blues. Aporta la b3 (#9) y la 11.'},
                { name: 'Dominante del b5', pentatonicRoot: (r) => (r + 6) % 12, type: 'dom7', logic: 'Opción de Tritono, sonido alterado (b9, #11, b13).'},
            ],
            'm7b5': [
                { name: 'Menor del b3', pentatonicRoot: (r) => (r + 3) % 12, type: 'minor', logic: 'Sonido Locrio (con b5 y b2/b9). Aporta la tensión b13.' },
                { name: 'm7b5 de la raíz', pentatonicRoot: (r) => r, type: 'm7b5', logic: 'La escala más directa (Locria). Aporta la tensión 11.'},
                { name: 'Dominante del b6', pentatonicRoot: (r) => (r + 8) % 12, type: 'dom7', logic: 'Aporta la tensión b13.'},
                { name: 'Menor del b7', pentatonicRoot: (r) => (r + 10) % 12, type: 'minor', logic: 'Sonido Locrio. Aporta b9, 11 y b13.'},
                { name: 'Majb6 del b7', pentatonicRoot: (r) => (r + 10) % 12, type: 'majb6', logic: 'Sonido Locrio ♮2. Aporta las tensiones 9 y 11.'}
            ],
            'alt': [
                { name: 'Menor del #9 (b3)', pentatonicRoot: (r) => (r + 3) % 12, type: 'minor', logic: 'Sonido Alterado. Cubre b9, #9, #11 y b13.' },
                { name: 'Dominante del b5', pentatonicRoot: (r) => (r + 6) % 12, type: 'dom7', logic: 'Opción de Tritono. Cubre b9, #11 y b13.' },
                { name: 'm7b5 del b7', pentatonicRoot: (r) => (r + 10) % 12, type: 'm7b5', logic: 'Cubre las tensiones b9, #9, #11 y b13 (#5).'},
                { name: 'Majb6 del b6', pentatonicRoot: (r) => (r + 8) % 12, type: 'majb6', logic: 'Sonido Alterado. Cubre las tensiones #9, #11 y b13(#5).'}
            ]
        };
        const guitarTuning = [4, 9, 2, 7, 11, 4]; // E A D G B e

        const ARPEGGIO_DEFINITIONS = {
            'minor': {
                notesMap: {'1': 0, 'b3': 1, '4': 2, '5': 3, 'b7': 4},
                triadas: [
                    { quality: 'm', rootKey: '1', notes: ['1', 'b3', '5'] },
                    { quality: 'sus2', rootKey: 'b3', notes: ['b3', '4', 'b7'] },
                    { quality: 'sus2', rootKey: '4', notes: ['4', '5', '1'] },
                    { quality: '', rootKey: 'b3', bassKey: '5', notes: ['5', 'b7', 'b3'] },
                    { quality: 'sus2', rootKey: 'b7', notes: ['b7', '1', '4'] }
                ],
                tetradas: [
                    { quality: 'm7', rootKey: '1', notes: ['1', 'b3', '5', 'b7'] },
                    { quality: '6sus2', rootKey: 'b3', notes: ['b3', '4', 'b7', '1'] },
                    { quality: '7sus2', rootKey: '4', notes: ['4', '5', '1', 'b3'] },
                    { quality: 'add9', rootKey: 'b3', bassKey: '5', notes: ['5', 'b7', 'b3', '4'] },
                    { quality: '6sus2', rootKey: 'b7', notes: ['b7', '1', '4', '5'] }
                ]
            },
            'dom7': {
                notesMap: {'1': 0, '2': 1, '3': 2, '5': 3, 'b7': 4},
                triadas: [
                    { quality: '', rootKey: '1', notes: ['1', '3', '5'] },
                    { quality: 'm', rootKey: '5', bassKey: '2', notes: ['2', '5', 'b7'] },
                    { quality: '7(omit5)', rootKey: '1', bassKey: '3', notes: ['3', 'b7', '1'] },
                    { quality: 'sus4', rootKey: '5', notes: ['5', '1', '2'] },
                    { quality: '', rootKey: '2', bassKey: 'b7', notes: ['b7', '2', '5'] }
                ],
                tetradas: [
                    { quality: '7', rootKey: '1', notes: ['1', '3', '5', 'b7'] },
                    { quality: 'm7', rootKey: '5', bassKey: '2', notes: ['2', '5', 'b7', '1'] },
                    { quality: '7(add9)', rootKey: '1', bassKey: '3', notes: ['3', 'b7', '1', '2'] },
                    { quality: 'm6', rootKey: '5', notes: ['5', 'b7', '2', '3'] },
                    { quality: 'sus2', rootKey: '1', bassKey: 'b7', notes: ['b7', '1', '2', '5'] }
                ]
            },
            'm7b5': {
                notesMap: {'1': 0, 'b3': 1, '4': 2, 'b5': 3, 'b7': 4},
                triadas: [
                    { quality: 'sus4', rootKey: '1', notes: ['1', '4', 'b7'] },
                    { quality: 'dim', rootKey: '1', bassKey: 'b3', notes: ['b3', 'b5', '1'] },
                    { quality: ' (cuartal)', rootKey: '4', notes: ['4', 'b7', 'b3'] },
                    { quality: ' (shell)', rootKey: 'b5', notes: ['b5', 'b7', '4'] },
                    { quality: 'sus4', rootKey: '1', bassKey: 'b7', notes: ['b7', '1', '4'] }
                ],
                tetradas: [
                    { quality: 'm7b5', rootKey: '1', notes: ['1', 'b3', 'b5', 'b7'] },
                    { quality: 'dim(add11)', rootKey: '1', bassKey: 'b3', notes: ['b3', 'b5', '1', '4'] },
                    { quality: 'm7sus4', rootKey: '1', notes: ['4', 'b7', '1', 'b3'] },
                    { quality: '7sus4', rootKey: 'b7', bassKey: 'b5', notes: ['b5', 'b7', '1', '4'] },
                    { quality: 'm7', rootKey: '4', bassKey: 'b7', notes: ['b7', '1', 'b3', '4'] }
                ]
            },
            'majb6': {
                notesMap: {'1': 0, '2': 1, '3': 2, '5': 3, 'b6': 4},
                triadas: [
                    { quality: 'sus2', rootKey: '1', notes: ['1', '2', '5'] },
                    { quality: '', rootKey: '1', bassKey: '2', notes: ['2', '5', '1'] },
                    { quality: 'aug', rootKey: '3', notes: ['3', 'b6', '1'] },
                    { quality: '', rootKey: '1', bassKey: '5', notes: ['5', '1', '3'] },
                    { quality: 'aug', rootKey: 'b6', notes: ['b6', '1', '3'] }
                ],
                tetradas: [
                    { quality: 'maj7#5', rootKey: 'b6', notes: ['1', '3', '5', 'b6'] },
                    { quality: 'maj7', rootKey: '1', bassKey: '2', notes: ['2', '3', '5', '1'] },
                    { quality: '7aug', rootKey: '3', notes: ['3', 'b6', '1', '2'] },
                    { quality: 'sus4(b9)', rootKey: '5', notes: ['5', 'b6', '1', '2'] },
                    { quality: 'maj7#11', rootKey: 'b6', notes: ['b6', '1', '2', '3'] }
                ]
            }
        };

        const getArpeggiosForPentatonic = (pentatonicNotes, type) => {
            const definitions = ARPEGGIO_DEFINITIONS[type];
            if (!definitions || !pentatonicNotes || pentatonicNotes.length !== 5) {
                return { triadas: [], tetradas: [] };
            }

            const formatArpeggio = (definition) => {
                try {
                    const arpeggioNotes = definition.notes.map(noteKey => pentatonicNotes[definitions.notesMap[noteKey]]);
                    const chordRootNote = pentatonicNotes[definitions.notesMap[definition.rootKey]];
                    let finalName = `${chordRootNote}${definition.quality}`;
                    if (definition.bassKey) {
                        const bassNote = pentatonicNotes[definitions.notesMap[definition.bassKey]];
                        finalName += `/${bassNote}`;
                    }
                    return `${finalName}: ${arpeggioNotes.join(', ')}`;
                } catch (e) {
                    console.error(e.message, {definition, pentatonicNotes, type});
                    return 'Error: Invalid arpeggio definition';
                }
            };
            
            const triadas = definitions.triadas.map(formatArpeggio);
            const tetradas = definitions.tetradas.map(formatArpeggio);

            return { triadas, tetradas };
        };

        // --- Tone.js and other variables ---
        let isToneStarted = false;
        const reverb = new Tone.Reverb({ decay: 1.5, preDelay: 0.01 }).toDestination();
        const melodySynth = new Tone.FMSynth({
            harmonicity: 1.5,
            modulationIndex: 8,
            envelope: { attack: 0.01, decay: 0.3, sustain: 0.1, release: 0.8 },
            modulationEnvelope: { attack: 0.01, decay: 0.15, sustain: 0.1, release: 0.2 }
        }).connect(reverb);
        const chordSynth = new Tone.PolySynth(Tone.FMSynth).connect(reverb);
        const stopPlayback = () => { if(Tone.Transport.state === 'started') {Tone.Transport.stop();} Tone.Transport.cancel(); };
        
        // State for melody labs
        const melodyLabs = {
            'simple': { randomPart: [], arpeggioPart: [] },
            'prog': { randomPart: [], arpeggioPart: [] }
        };
        let progressionUseFlats = false;
        let currentProgressionType = 'major';


        // --- DOM Elements ---
        // Simple Tab
        const rootNoteSelect = document.getElementById('root-note');
        const chordTypeSelect = document.getElementById('chord-type');
        const tableBody = document.getElementById('scale-table-body');
        
        // Progression Tab
        const progressionKeySelect = document.getElementById('progression-key');
        const progressionContainer = document.getElementById('progression-container');

        const createFretboard = (containerId, numFrets = 17) => {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = ''; 

            const area = document.createElement('div');
            area.className = 'fretboard-area';
            
            const content = document.createElement('div');
            content.className = 'fretboard-content';

            const openStringsContainer = document.createElement('div');
            openStringsContainer.className = 'open-strings';
            ['E', 'B', 'G', 'D', 'A', 'E'].forEach((noteName, i) => {
                const nameDiv = document.createElement('div');
                nameDiv.className = 'open-string-name';
                nameDiv.textContent = noteName;
                nameDiv.dataset.note = noteName;
                openStringsContainer.appendChild(nameDiv);
            });
            content.appendChild(openStringsContainer);

            const wrapper = document.createElement('div');
            wrapper.className = 'fretboard-wrapper';

            const fretboard = document.createElement('div');
            fretboard.className = 'fretboard';
            
            const reversedTuning = [...guitarTuning].reverse();
            reversedTuning.forEach((openNoteIndex, stringIndex) => {
                const stringDiv = document.createElement('div');
                stringDiv.className = 'string';
                
                const nut = document.createElement('div');
                nut.className = 'fret nut';
                stringDiv.appendChild(nut);
                
                for (let i = 0; i < numFrets; i++) {
                    const fret = document.createElement('div');
                    fret.className = 'fret';
                    const noteIndex = (openNoteIndex + i + 1) % 12;
                    fret.dataset.note = SHARP_NOTES[noteIndex];
                    
                    const noteFixed = document.createElement('div');
                    noteFixed.className = 'note-fixed';
                    noteFixed.textContent = SHARP_NOTES[noteIndex];
                    fret.appendChild(noteFixed);

                    stringDiv.appendChild(fret);
                }
                fretboard.appendChild(stringDiv);
            });
            wrapper.appendChild(fretboard);
            
            const inlayContainer = document.createElement('div');
            inlayContainer.className = 'inlay-container';
            const markers = { 3: 'single', 5: 'single', 7: 'single', 9: 'single', 12: 'double', 15: 'single', 17: 'single' };
            
            for (let i = 1; i <= numFrets; i++) {
                const inlayFret = document.createElement('div');
                inlayFret.className = 'inlay-fret';
                if (markers[i]) {
                    const dot = document.createElement('div');
                    dot.className = `inlay-dot ${markers[i] === 'double' ? 'double' : ''}`;
                    inlayFret.appendChild(dot);
                }
                inlayContainer.appendChild(inlayFret);
            }
            wrapper.appendChild(inlayContainer);
            content.appendChild(wrapper);
            area.appendChild(content);

            const fretNumbersContainer = document.createElement('div');
            fretNumbersContainer.className = 'fret-numbers';
            const numbers = { 3: '3', 5: '5', 7: '7', 9: '9', 12: '12', 15: '15' };
            const nutSpacer = document.createElement('div');
            nutSpacer.style.width = '10px'; 
            nutSpacer.style.flexShrink = '0';
            fretNumbersContainer.appendChild(nutSpacer);
            for (let i = 1; i <= numFrets; i++) {
                const numDiv = document.createElement('div');
                numDiv.className = 'fret-number';
                if (numbers[i]) numDiv.textContent = numbers[i];
                fretNumbersContainer.appendChild(numDiv);
            }
            area.appendChild(fretNumbersContainer);
            container.appendChild(area);
        };

        const updateFretboard = (containerId, rootNote, scaleNotes, preferredNotes) => {
            document.querySelectorAll(`#${containerId} .note-fixed, #${containerId} .open-string-name`).forEach(el => el.classList.remove('in-scale', 'root'));

            const scaleNoteIndices = scaleNotes.map(noteNameToIndex);
            const rootNoteIndex = noteNameToIndex(rootNote);
            const reversedTuning = [...guitarTuning].reverse();

            for (let string = 0; string < 6; string++) {
                const openNoteIndex = reversedTuning[string];
                const openStringLabel = document.querySelector(`#${containerId} .open-string-name:nth-child(${string + 1})`);
                 if(openStringLabel) {
                    openStringLabel.dataset.note = preferredNotes[openNoteIndex];
                    if (scaleNoteIndices.includes(openNoteIndex % 12)) {
                        openStringLabel.classList.add('in-scale');
                        if (openNoteIndex % 12 === rootNoteIndex) openStringLabel.classList.add('root');
                    }
                 }
                
                const stringDiv = document.querySelector(`#${containerId} .fretboard .string:nth-child(${string + 1})`);
                if (!stringDiv) continue;

                const frets = stringDiv.querySelectorAll('.fret:not(.nut)');
                frets.forEach((fretDiv, fretIndex) => {
                    const currentNoteIndex = (openNoteIndex + fretIndex + 1) % 12;
                    const noteEl = fretDiv.querySelector('.note-fixed');
                    if (noteEl) {
                       noteEl.textContent = preferredNotes[currentNoteIndex];
                       fretDiv.dataset.note = preferredNotes[currentNoteIndex];
                       if (scaleNoteIndices.includes(currentNoteIndex)) {
                           noteEl.classList.add('in-scale');
                           if (currentNoteIndex === rootNoteIndex) noteEl.classList.add('root');
                       }
                    }
                });
            }
        };

        const renderSimpleMode = () => {
            const rootNote = rootNoteSelect.value;
            const chordType = chordTypeSelect.value;
            const preferredNotes = getPreferredNotes(rootNote, chordType);
            tableBody.innerHTML = '';
            
            (pentatonicToChordRelations[chordType] || []).forEach(rel => {
                const pentatonicRootIndex = rel.pentatonicRoot(noteNameToIndex(rootNote));
                const pentatonicRoot = preferredNotes[pentatonicRootIndex];
                let pentatonicNotes = pentatonicFormulas[rel.type].map(interval => getNoteFromInterval(pentatonicRoot, interval, preferredNotes));
                const degrees = pentatonicNotes.map(note => getIntervalName(rootNote, note, chordType));
                
                const arpeggios = getArpeggiosForPentatonic(pentatonicNotes, rel.type);
                const triadasHtml = `<td data-arpeggios='${JSON.stringify(arpeggios.triadas)}'><div class="example-box">${arpeggios.triadas.join('\n')}</div></td>`;
                const tetradasHtml = `<td data-arpeggios='${JSON.stringify(arpeggios.tetradas)}'><div class="example-box">${arpeggios.tetradas.join('\n')}</div></td>`;

                const row = document.createElement('tr');
                row.dataset.notes = pentatonicNotes.join(',');
                row.dataset.root = pentatonicRoot;
                row.dataset.type = rel.type;
                const displayName = PENTATONIC_DISPLAY_NAMES[rel.type] || rel.type;

                row.innerHTML = `
                    <td>
                        <div class="font-bold text-lg">${pentatonicRoot} <span class="text-sm text-gray-400">${displayName}</span></div>
                        <div class="text-xs mt-1">${pentatonicNotes.join(', ')}</div>
                    </td>
                    ${triadasHtml} ${tetradasHtml}
                    <td><div class="example-box">${degrees.join(', ')}</div></td>
                    <td>${rel.logic}</td>
                `;
                row.addEventListener('click', (e) => {
                    document.querySelectorAll('#scale-table-body tr').forEach(r => r.classList.remove('selected-row'));
                    e.currentTarget.classList.add('selected-row');
                    updateFretboardAndArpeggios(e.currentTarget);
                    melodyLabs.simple.randomPart = [];
                    melodyLabs.simple.arpeggioPart = [];
                    updateMelodyDisplay('simple');
                });
                tableBody.appendChild(row);
            });
            if (tableBody.firstChild) tableBody.firstChild.click();
        };

        const updateFretboardAndArpeggios = (row) => {
            const currentRoot = row.dataset.root;
            const currentNotes = row.dataset.notes.split(',');
            const hasSharp = currentNotes.some(n => n.includes('#') && !n.includes('b'));
            const currentPreferred = hasSharp ? SHARP_NOTES : FLAT_NOTES;
            updateFretboard('fretboard-container-simple', currentRoot, currentNotes, currentPreferred);
            populateArpeggioSelector('simple');
        };

        const fillSelects = () => {
            Object.keys(KEY_SIGNATURES).forEach(note => {
                const option = `<option value="${note}">${note}</option>`;
                rootNoteSelect.innerHTML += option;
                progressionKeySelect.innerHTML += option;
            });
            Object.keys(chordTypes).forEach(type => {
                chordTypeSelect.innerHTML += `<option value="${type}">${chordTypes[type]}</option>`;
            });
            rootNoteSelect.value = 'C';
            chordTypeSelect.value = 'maj7';
            progressionKeySelect.value = 'C';
        };

        const setupEventListeners = () => {
            document.querySelectorAll('button, select').forEach(btn => {
                btn.addEventListener('click', async () => { if (!isToneStarted) { await Tone.start(); isToneStarted = true; } });
            });

            rootNoteSelect.addEventListener('change', () => {
                melodyLabs.simple.randomPart = []; melodyLabs.simple.arpeggioPart = [];
                updateMelodyDisplay('simple'); renderSimpleMode();
            });
            chordTypeSelect.addEventListener('change', () => {
                melodyLabs.simple.randomPart = []; melodyLabs.simple.arpeggioPart = [];
                updateMelodyDisplay('simple'); renderSimpleMode();
            });

            document.getElementById('enharmonic-btn').addEventListener('click', () => handleEnharmonicClick('simple'));
            document.getElementById('enharmonic-btn-prog').addEventListener('click', () => {
                const selectedLi = document.querySelector('#progression-container li.selected-scale');
                if (selectedLi) {
                    handleSingleLiEnharmonic(selectedLi);
                } else {
                    progressionUseFlats = !progressionUseFlats;
                    renderProgression();
                }
            });
            
            setupMelodyLab('simple');
            setupMelodyLab('prog');
            
            // Progression Listeners
            progressionKeySelect.addEventListener('change', renderProgression);
             document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                    document.getElementById(`tab-${button.dataset.tab}`).classList.remove('hidden');
                });
            });

            document.querySelectorAll('.prog-type-selector button').forEach(button => {
                button.addEventListener('click', () => {
                    document.querySelectorAll('.prog-type-selector button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    currentProgressionType = button.dataset.progType;
                    renderProgression();
                });
            });

            progressionContainer.addEventListener('click', (e) => {
                const targetLi = e.target.closest('li');
                if (targetLi) {
                    progressionContainer.querySelectorAll('li').forEach(li => li.classList.remove('selected-scale'));
                    targetLi.classList.add('selected-scale');
                    const root = targetLi.dataset.root;
                    const notes = targetLi.dataset.notes.split(',');
                    const preferredType = targetLi.dataset.preferred;
                    const preferredNotes = preferredType === 'sharp' ? SHARP_NOTES : FLAT_NOTES;
                    updateFretboard('fretboard-container-progression', root, notes, preferredNotes);
                    populateArpeggioSelector('prog');
                    document.getElementById('arpeggio-select-prog').disabled = false;

                }
            });

            // Interactive Fretboard
            document.getElementById('fretboard-container-simple').addEventListener('click', (e) => handleFretboardClick(e, 'simple'));
            document.getElementById('fretboard-container-progression').addEventListener('click', (e) => handleFretboardClick(e, 'prog'));
        };

        function handleFretboardClick(e, labKey) {
            if (e.target.classList.contains('fret') || e.target.classList.contains('open-string-name')) {
                const note = e.target.dataset.note;
                if(note) {
                    melodySynth.triggerAttackRelease(note + '4', '8n');
                    melodyLabs[labKey].randomPart.push(note);
                    updateMelodyDisplay(labKey);
                }
            }
        }

        function handleSingleLiEnharmonic(li) {
            const currentNotes = li.dataset.notes.split(',');
            const newNotes = currentNotes.map(note => ENHARMONIC_MAP[note] || note);
            const currentRoot = li.dataset.root;
            const newRoot = ENHARMONIC_MAP[currentRoot] || currentRoot;
            const newPreferredType = li.dataset.preferred === 'sharp' ? 'flat' : 'sharp';
            const newPreferredNotes = newPreferredType === 'sharp' ? SHARP_NOTES : FLAT_NOTES;
            const type = li.dataset.type;
            
            li.dataset.notes = newNotes.join(',');
            li.dataset.root = newRoot;
            li.dataset.preferred = newPreferredType;

            li.innerHTML = `<span class="text-blue-400 font-semibold">${newRoot} ${PENTATONIC_DISPLAY_NAMES[type] || type}</span>`;

            updateFretboard('fretboard-container-progression', newRoot, newNotes, newPreferredNotes);
            populateArpeggioSelector('prog');
        }


        function handleEnharmonicClick(labKey) {
            const selectedRow = document.querySelector('#scale-table-body .selected-row');
            if (!selectedRow) return;

            const currentNotes = selectedRow.dataset.notes.split(',').map(note => ENHARMONIC_MAP[note] || note);
            const currentRoot = ENHARMONIC_MAP[selectedRow.dataset.root] || selectedRow.dataset.root;
            const type = selectedRow.dataset.type;

            selectedRow.dataset.notes = currentNotes.join(',');
            selectedRow.dataset.root = currentRoot;

            const displayName = PENTATONIC_DISPLAY_NAMES[type] || type;
            selectedRow.querySelector('.font-bold').innerHTML = `${currentRoot} <span class="text-sm text-gray-400">${displayName}</span>`;
            selectedRow.querySelector('.text-xs').textContent = currentNotes.join(', ');
            
            const arpeggios = getArpeggiosForPentatonic(currentNotes, type);
            const cells = selectedRow.getElementsByTagName('td');
            cells[1].dataset.arpeggios = JSON.stringify(arpeggios.triadas);
            cells[1].querySelector('.example-box').textContent = arpeggios.triadas.join('\n');
            cells[2].dataset.arpeggios = JSON.stringify(arpeggios.tetradas);
            cells[2].querySelector('.example-box').textContent = arpeggios.tetradas.join('\n');
            
            updateFretboardAndArpeggios(selectedRow);
        }

        function setupMelodyLab(labKey) {
            const suffix = labKey === 'prog' ? '-prog' : '';
            const bpmSlider = document.getElementById(`bpm-slider${suffix}`);
            const bpmValue = document.getElementById(`bpm-value${suffix}`);
            const arpeggioTypeSelect = document.getElementById(`arpeggio-type-select${suffix}`);
            const addArpeggioBtn = document.getElementById(`add-arpeggio-btn${suffix}`);
            const addRandomBtn = document.getElementById(`add-random-btn${suffix}`);
            const playMelodyBtn = document.getElementById(`play-melody-btn${suffix}`);
            const stopBtn = document.getElementById(`stop-melody-btn${suffix}`);
            const clearBtn = document.getElementById(`clear-melody-btn${suffix}`);
            
            bpmSlider.addEventListener('input', (e) => {
                const newBpm = e.target.value;
                Tone.Transport.bpm.value = newBpm;
                bpmValue.textContent = `${newBpm} BPM`;
            });
            Tone.Transport.bpm.value = bpmSlider.value;

            arpeggioTypeSelect.addEventListener('change', () => populateArpeggioSelector(labKey));
            addArpeggioBtn.addEventListener('click', () => addArpeggioToMelody(labKey));
            addRandomBtn.addEventListener('click', () => addRandomNotesToMelody(labKey));
            playMelodyBtn.addEventListener('click', () => playMelody(labKey));
            stopBtn.addEventListener('click', stopPlayback);
            clearBtn.addEventListener('click', () => {
                melodyLabs[labKey].randomPart = [];
                melodyLabs[labKey].arpeggioPart = [];
                updateMelodyDisplay(labKey);
            });
            if(labKey === 'simple') {
                 document.getElementById('play-arpeggios-btn').addEventListener('click', () => playArpeggios('simple'));
            }
        }
        
        function updateMelodyDisplay(labKey) {
            const suffix = labKey === 'prog' ? '-prog' : '';
            const generatorOutput = document.getElementById(`generator-output${suffix}`);
            const fullMelody = [...melodyLabs[labKey].randomPart, ...melodyLabs[labKey].arpeggioPart];
            generatorOutput.textContent = fullMelody.length > 0 ? fullMelody.join(' - ') : '';
        }

        function populateArpeggioSelector(labKey) {
            const suffix = labKey === 'prog' ? '-prog' : '';
            const arpeggioSelect = document.getElementById(`arpeggio-select${suffix}`);
            arpeggioSelect.innerHTML = '';
            
            let sourceElement;
            if (labKey === 'simple') {
                sourceElement = document.querySelector('#scale-table-body .selected-row');
            } else { // prog
                sourceElement = document.querySelector('#progression-container li.selected-scale');
            }
            if (!sourceElement) {
                if(labKey === 'prog') arpeggioSelect.disabled = true;
                return;
            }

            const type = document.getElementById(`arpeggio-type-select${suffix}`).value;
            const pentatonicNotes = sourceElement.dataset.notes.split(',');
            const pentatonicType = sourceElement.dataset.type;
            
            const arpeggios = getArpeggiosForPentatonic(pentatonicNotes, pentatonicType);
            const list = type === 'triads' ? arpeggios.triadas : arpeggios.tetradas;
            
            list.forEach(arpString => {
                const option = document.createElement('option');
                option.value = arpString;
                option.textContent = arpString.trim();
                arpeggioSelect.appendChild(option);
            });
        }
        
        function addArpeggioToMelody(labKey) {
            const suffix = labKey === 'prog' ? '-prog' : '';
            const arpString = document.getElementById(`arpeggio-select${suffix}`).value;
            if (!arpString) return;
            
            let arpeggioNotes = arpString.split(':')[1].trim().split(', ');
            if(document.getElementById(`arpeggio-random-order${suffix}`).checked) {
                arpeggioNotes.sort(() => 0.5 - Math.random());
            }

            melodyLabs[labKey].arpeggioPart = arpeggioNotes;
            updateMelodyDisplay(labKey);
        }

        function addRandomNotesToMelody(labKey) {
            const suffix = labKey === 'prog' ? '-prog' : '';
            const generatorOutput = document.getElementById(`generator-output${suffix}`);

            let sourceElement;
            if(labKey === 'simple') {
                sourceElement = document.querySelector('#scale-table-body .selected-row');
            } else {
                sourceElement = document.querySelector('#progression-container li.selected-scale');
            }

            if (!sourceElement) {
                generatorOutput.textContent = "Selecciona una escala primero.";
                setTimeout(() => { if (generatorOutput.textContent.includes("Selecciona")) generatorOutput.textContent = "" }, 2000);
                return;
            }

            const scaleNotes = sourceElement.dataset.notes.split(',');
            const count = parseInt(document.getElementById(`random-note-count${suffix}`).value, 10);
            
            if (isNaN(count) || count < 1 || count > 5) {
                generatorOutput.textContent = "Número de notas debe ser entre 1 y 5.";
                setTimeout(() => { if (generatorOutput.textContent.includes("Número")) generatorOutput.textContent = "" }, 2000);
                return;
            }

            const shuffled = [...scaleNotes].sort(() => 0.5 - Math.random());
            melodyLabs[labKey].randomPart = shuffled.slice(0, count);
            updateMelodyDisplay(labKey);
        }

        function playMelody(labKey) {
            stopPlayback();
            const fullMelody = [...melodyLabs[labKey].randomPart, ...melodyLabs[labKey].arpeggioPart];
            if (fullMelody.length === 0) return;

            const suffix = labKey === 'prog' ? '-prog' : '';
            const generatorOutput = document.getElementById(`generator-output${suffix}`);
            const rhythm = document.getElementById(`rhythm-select${suffix}`).value;

            const melodyString = fullMelody.join(' - ');
            const notesWithOctaves = assignOctaves(fullMelody);
            
            generatorOutput.innerHTML = '';
            fullMelody.forEach((note, index) => {
                const noteSpan = document.createElement('span');
                noteSpan.id = `melody-note-${labKey}-${index}`;
                noteSpan.className = 'note-span';
                noteSpan.textContent = note;
                generatorOutput.appendChild(noteSpan);
                if (index < fullMelody.length - 1) generatorOutput.appendChild(document.createTextNode(' - '));
            });
             
            const indices = Array.from(Array(fullMelody.length).keys());

            const sequence = new Tone.Sequence((time, index) => {
                const note = fullMelody[index];
                const noteWithOctave = notesWithOctaves[index];
                melodySynth.triggerAttackRelease(noteWithOctave, rhythm, time);
                
                Tone.Draw.schedule(() => {
                    highlightNote(note, 'add', Tone.Time(rhythm).toMilliseconds());
                    const noteSpan = document.getElementById(`melody-note-${labKey}-${index}`);
                    if (noteSpan) {
                        noteSpan.classList.add('playing');
                        setTimeout(() => noteSpan.classList.remove('playing'), Tone.Time(rhythm).toMilliseconds());
                    }
                }, time);

            }, indices, rhythm);
            
            sequence.loop = false;
            sequence.start(0);
            const duration = fullMelody.length * Tone.Time(rhythm).toSeconds();
            Tone.Transport.scheduleOnce(() => {
                stopPlayback();
                generatorOutput.textContent = melodyString;
            }, duration + 0.1);

            Tone.Transport.start();
        }
        
        function playArpeggios() {
            stopPlayback();
            const selectedRow = document.querySelector('#scale-table-body .selected-row');
            if (!selectedRow) return;

            const type = document.getElementById('arpeggio-type-select').value;
            const cellIndex = type === 'triads' ? 1 : 2;
            const arpeggioCell = selectedRow.cells[cellIndex];
            if (!arpeggioCell || !arpeggioCell.dataset.arpeggios) return;

            const arpeggiosRaw = JSON.parse(arpeggioCell.dataset.arpeggios);
            const arpeggiosNotes = arpeggiosRaw.map(arp => arp.split(':')[1].trim().split(', '));
            const rhythm = document.getElementById('rhythm-select').value;
            
            const sequenceNotes = [];
            arpeggiosNotes.forEach(arp => sequenceNotes.push(...arp, null));

            const notesWithOctaves = assignOctaves(sequenceNotes);
            const indices = Array.from(Array(sequenceNotes.length).keys());
            
            const sequence = new Tone.Sequence((time, index) => {
                const noteWithOctave = notesWithOctaves[index];
                if (noteWithOctave) {
                    const noteName = sequenceNotes[index];
                    melodySynth.triggerAttackRelease(noteWithOctave, rhythm, time);
                    Tone.Draw.schedule(() => highlightNote(noteName, 'add', Tone.Time(rhythm).toMilliseconds()), time);
                }
            }, indices, rhythm);
            sequence.loop = false;
            sequence.start(0);

            const duration = sequenceNotes.length * Tone.Time(rhythm).toSeconds();
            Tone.Transport.scheduleOnce(() => stopPlayback(), duration + 0.1);
            Tone.Transport.start();
        }

        function highlightNote(note, action, duration) {
            const allElements = document.querySelectorAll(`.note-fixed, .open-string-name`);
            allElements.forEach(el => {
                if (el.textContent === note || el.dataset.note === note) {
                    if (action === 'add') {
                        el.classList.add('playing');
                        setTimeout(() => el.classList.remove('playing'), duration);
                    } else {
                         el.classList.remove('playing');
                    }
                }
            });
        }
        
         // --- PROGRESSION LOGIC ---
        function renderProgression() {
            const key = progressionKeySelect.value;
            const preferredKeyNotes = progressionUseFlats ? FLAT_NOTES : getPreferredNotes(key);
            let progressionChords;
            
            if (currentProgressionType === 'major') {
                 progressionChords = [
                    { name: `${getNoteFromInterval(key, 2, preferredKeyNotes)}m7`, type: 'm7', root: getNoteFromInterval(key, 2, preferredKeyNotes) }, 
                    { name: `${getNoteFromInterval(key, 7, preferredKeyNotes)}7`, type: 'dom7', root: getNoteFromInterval(key, 7, preferredKeyNotes) }, 
                    { name: `${key}maj7`, type: 'maj7', root: key }
                 ];
            } else { // minor
                 progressionChords = [
                    { name: `${getNoteFromInterval(key, 2, preferredKeyNotes)}m7(b5)`, type: 'm7b5', root: getNoteFromInterval(key, 2, preferredKeyNotes) }, 
                    { name: `${getNoteFromInterval(key, 7, preferredKeyNotes)}7alt`, type: 'alt', root: getNoteFromInterval(key, 7, preferredKeyNotes) }, 
                    { name: `${key}m7`, type: 'm7', root: key }
                 ];
            }

            progressionContainer.innerHTML = '';
            progressionChords.forEach(chord => {
                const chordRootNotes = progressionUseFlats ? FLAT_NOTES : getPreferredNotes(chord.root, chord.type);
                let suggestionsHtml = (pentatonicToChordRelations[chord.type] || []).map(rel => {
                    const pRootIndex = rel.pentatonicRoot(noteNameToIndex(chord.root));
                    const pRoot = chordRootNotes[pRootIndex];
                    const pNotes = pentatonicFormulas[rel.type].map(i => getNoteFromInterval(pRoot, i, chordRootNotes)).join(',');
                    const preferredType = chordRootNotes === SHARP_NOTES ? 'sharp' : 'flat';

                    return `<li class="text-sm cursor-pointer hover:bg-gray-600 p-1 rounded" data-root="${pRoot}" data-type="${rel.type}" data-notes="${pNotes}" data-preferred="${preferredType}">
                                <span class="text-blue-400 font-semibold">${pRoot} ${PENTATONIC_DISPLAY_NAMES[rel.type] || rel.type}</span>
                            </li>`;
                }).join('');

                const column = document.createElement('div');
                column.className = 'chord-column';
                column.innerHTML = `
                    <div class="chord-box">${chord.name}</div>
                    <div class="progression-card mt-2">
                        <p class="text-sm font-semibold mb-2">Pentatónicas sugeridas:</p>
                        <ul class="scale-suggestions space-y-1">${suggestionsHtml}</ul>
                    </div>`;
                progressionContainer.appendChild(column);
            });
             if (progressionContainer.querySelector('li')) {
                progressionContainer.querySelector('li').click();
            }
        }

        // --- START APP ---
        fillSelects();
        createFretboard('fretboard-container-simple');
        createFretboard('fretboard-container-progression');
        setupEventListeners();
        renderProgression();
        renderSimpleMode(); 
    });
    </script>
</body>
</html>

